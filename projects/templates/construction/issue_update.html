{% extends 'base.html' %}
{% load static %}

{% block title %}課題更新{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-edit"></i> 課題更新</h2>
                <a href="{% url 'projects:construction_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> 戻る
                </a>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5>課題ID: #{{ issue.id|default:"新規" }} - {{ issue.title|default:"新規課題" }}</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_title" class="form-label">課題タイトル <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="id_title" name="title"
                                           value="{{ issue.title|default:'' }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_status" class="form-label">ステータス <span class="text-danger">*</span></label>
                                    <select class="form-select" id="id_status" name="status" required>
                                        <option value="open" {% if issue.status == 'open' %}selected{% endif %}>未対応</option>
                                        <option value="in_progress" {% if issue.status == 'in_progress' %}selected{% endif %}>対応中</option>
                                        <option value="resolved" {% if issue.status == 'resolved' %}selected{% endif %}>解決済み</option>
                                        <option value="closed" {% if issue.status == 'closed' %}selected{% endif %}>完了</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_priority" class="form-label">優先度 <span class="text-danger">*</span></label>
                                    <select class="form-select" id="id_priority" name="priority" required>
                                        <option value="low" {% if issue.priority == 'low' %}selected{% endif %}>低</option>
                                        <option value="medium" {% if issue.priority == 'medium' %}selected{% endif %}>中</option>
                                        <option value="high" {% if issue.priority == 'high' %}selected{% endif %}>高</option>
                                        <option value="urgent" {% if issue.priority == 'urgent' %}selected{% endif %}>緊急</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_category" class="form-label">カテゴリー</label>
                                    <select class="form-select" id="id_category" name="category">
                                        <option value="">選択してください</option>
                                        <option value="quality" {% if issue.category == 'quality' %}selected{% endif %}>品質</option>
                                        <option value="safety" {% if issue.category == 'safety' %}selected{% endif %}>安全</option>
                                        <option value="schedule" {% if issue.category == 'schedule' %}selected{% endif %}>スケジュール</option>
                                        <option value="cost" {% if issue.category == 'cost' %}selected{% endif %}>コスト</option>
                                        <option value="material" {% if issue.category == 'material' %}selected{% endif %}>資材</option>
                                        <option value="other" {% if issue.category == 'other' %}selected{% endif %}>その他</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_due_date" class="form-label">対応期限</label>
                                    <input type="date" class="form-control" id="id_due_date" name="due_date"
                                           value="{{ issue.due_date|date:'Y-m-d' }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_assignee" class="form-label">担当者</label>
                                    <select class="form-select" id="id_assignee" name="assignee">
                                        <option value="">選択してください</option>
                                        {% for user in project_users %}
                                        <option value="{{ user.id }}" {% if issue.assignee_id == user.id %}selected{% endif %}>
                                            {{ user.get_full_name|default:user.username }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="id_description" class="form-label">課題内容 <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="id_description" name="description" rows="4" required
                                      placeholder="課題の詳細な内容を記載してください">{{ issue.description|default:'' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="id_resolution" class="form-label">対応内容</label>
                            <textarea class="form-control" id="id_resolution" name="resolution" rows="3"
                                      placeholder="対応・解決方法について記載してください">{{ issue.resolution|default:'' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="id_impact" class="form-label">影響範囲</label>
                            <textarea class="form-control" id="id_impact" name="impact" rows="3"
                                      placeholder="この課題が工事に与える影響について記載してください">{{ issue.impact|default:'' }}</textarea>
                        </div>

                        <!-- 進捗情報 -->
                        {% if issue.id %}
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6>課題情報</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>報告者:</strong> {{ issue.reporter|default:"-" }}
                                    </div>
                                    <div class="col-md-4">
                                        <strong>作成日:</strong> {{ issue.created_at|date:"Y/m/d H:i" }}
                                    </div>
                                    <div class="col-md-4">
                                        <strong>最終更新:</strong> {{ issue.updated_at|date:"Y/m/d H:i" }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'projects:construction_dashboard' %}" class="btn btn-secondary">
                                キャンセル
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> 更新
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ステータスと優先度による色分け
    const statusSelect = document.getElementById('id_status');
    const prioritySelect = document.getElementById('id_priority');

    function updateStatusColor() {
        const status = statusSelect.value;
        statusSelect.className = 'form-select';
        switch(status) {
            case 'open':
                statusSelect.classList.add('border-danger');
                break;
            case 'in_progress':
                statusSelect.classList.add('border-warning');
                break;
            case 'resolved':
                statusSelect.classList.add('border-info');
                break;
            case 'closed':
                statusSelect.classList.add('border-success');
                break;
        }
    }

    function updatePriorityColor() {
        const priority = prioritySelect.value;
        prioritySelect.className = 'form-select';
        switch(priority) {
            case 'urgent':
                prioritySelect.classList.add('border-danger');
                break;
            case 'high':
                prioritySelect.classList.add('border-warning');
                break;
            case 'medium':
                prioritySelect.classList.add('border-info');
                break;
            case 'low':
                prioritySelect.classList.add('border-success');
                break;
        }
    }

    statusSelect.addEventListener('change', updateStatusColor);
    prioritySelect.addEventListener('change', updatePriorityColor);

    // 初期状態の色を設定
    updateStatusColor();
    updatePriorityColor();
});
</script>
{% endblock %}