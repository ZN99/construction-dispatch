<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>職人スケジュール確認 - 建築派遣SaaS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <style>
        .priority-normal { border-left: 4px solid #28a745; }
        .priority-urgent { border-left: 4px solid #ffc107; }
        .priority-emergency { border-left: 4px solid #dc3545; }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #dee2e6;
        }

        .calendar-day {
            background-color: white;
            padding: 8px;
            min-height: 50px;
            border: none;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            background-color: #f8f9fa;
        }

        .calendar-day.selected {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
        }

        .calendar-day.weekend {
            background-color: #ffebee;
        }

        .calendar-day.today {
            background-color: #fff3e0;
            font-weight: bold;
        }

        .calendar-day.unavailable {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .existing-schedule {
            font-size: 0.7em;
            background-color: #ff9800;
            color: white;
            padding: 1px 4px;
            border-radius: 2px;
            margin-top: 2px;
        }

        .schedule-info {
            font-size: 0.65em;
            padding: 1px 3px;
            border-radius: 2px;
            margin-top: 2px;
            line-height: 1.2;
        }

        .schedule-info.busy {
            background-color: #dc3545;
            color: white;
        }

        .schedule-info.available {
            background-color: #28a745;
            color: white;
        }

        .calendar-day.craftsman-busy {
            background-color: #ffeaea;
            border: 1px solid #f5c6cb;
        }

        .calendar-day.craftsman-available {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .calendar-day.craftsman-busy.selected {
            background-color: #dc3545;
            color: white;
        }

        .calendar-day.craftsman-available.selected {
            background-color: #28a745;
            color: white;
        }

        .email-preview {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 0.9em;
            white-space: pre-line;
        }

        .contact-button {
            margin-bottom: 8px;
        }

        .progress-timeline {
            position: relative;
            padding-left: 30px;
        }

        .progress-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #dee2e6;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding-left: 15px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #28a745;
        }

        .timeline-item.pending::before {
            background-color: #ffc107;
        }

        .timeline-item.inactive::before {
            background-color: #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar">
                <div class="position-sticky pt-3">
                    <h5 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>メインメニュー</span>
                    </h5>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="../index.html">
                                <i class="fas fa-tachometer-alt me-2"></i>ダッシュボード
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../projects/project_list.html">
                                <i class="fas fa-project-diagram me-2"></i>案件管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../surveys/survey_list.html">
                                <i class="fas fa-clipboard-list me-2"></i>調査管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="craftsman_list.html">
                                <i class="fas fa-users me-2"></i>職人管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../material/supplier_list.html">
                                <i class="fas fa-building me-2"></i>資材業者
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="../pricing/pricing_list.html">
                                <i class="fas fa-yen-sign me-2"></i>見積管理
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">職人スケジュール確認</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <a href="craftsman_list.html" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>職人一覧に戻る
                            </a>
                        </div>
                    </div>
                </div>

                <!-- 案件情報表示エリア -->
                <div class="card mb-4 priority-urgent">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>案件情報
                            <span class="badge bg-danger ms-2">急ぎ</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-muted">案件番号</small>
                                <div class="fw-bold">#P2025-0915-001</div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">物件名・住所</small>
                                <div class="fw-bold">港区ワンルーム原状回復</div>
                                <div class="text-muted small">港区芝浦2-3-15 マンション芝浦 203号室</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">工事内容</small>
                                <div>クロス張替え（約35㎡）</div>
                                <div>ハウスクリーニング</div>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">希望工期</small>
                                <div class="fw-bold text-primary">3日間</div>
                                <small class="text-muted">納期: 2025年9月25日</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- 左カラム: 職人情報 & スケジュール -->
                    <div class="col-md-4">
                        <!-- 職人情報エリア -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-user me-2"></i>職人情報
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="me-3">
                                        <img src="https://via.placeholder.com/60x60" class="rounded-circle" alt="職人写真">
                                    </div>
                                    <div>
                                        <h6 class="mb-1">田中 太郎</h6>
                                        <small class="text-muted">ID: C001</small>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted">連絡先</small>
                                    <div><i class="fas fa-phone me-1"></i>090-1234-5678</div>
                                    <div><i class="fas fa-envelope me-1"></i>tanaka@example.com</div>
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted">専門分野</small>
                                    <div>
                                        <span class="badge bg-primary me-1">クロス張り</span>
                                        <span class="badge bg-info">原状回復</span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <small class="text-muted">スキルレベル</small>
                                    <div class="progress mt-1" style="height: 8px;">
                                        <div class="progress-bar bg-success" style="width: 85%"></div>
                                    </div>
                                    <small class="text-muted">経験年数: 8年</small>
                                </div>

                                <div>
                                    <small class="text-muted">過去の評価</small>
                                    <div>
                                        <span class="text-warning">
                                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="far fa-star"></i>
                                        </span>
                                        <span class="ms-1">4.2 (12件)</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- クイック連絡ボタン -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-bolt me-2"></i>クイック連絡
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <a href="tel:090-1234-5678" class="btn btn-success contact-button">
                                        <i class="fas fa-phone me-2"></i>電話をかける
                                    </a>
                                    <button class="btn btn-primary contact-button" onclick="scrollToEmail()">
                                        <i class="fas fa-envelope me-2"></i>メール作成
                                    </button>
                                    <a href="https://line.me/ti/p/example" class="btn btn-success contact-button" target="_blank">
                                        <i class="fab fa-line me-2"></i>LINEで連絡
                                    </a>
                                    <a href="craftsman_list.html" class="btn btn-outline-secondary contact-button">
                                        <i class="fas fa-search me-2"></i>他の職人を検索
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 中央カラム: メール作成 & 職人回答 -->
                    <div class="col-md-5">
                        <!-- メール文面作成エリア -->
                        <div class="card mb-4" id="email-section">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-envelope me-2"></i>スケジュール確認メール
                                </h5>
                            </div>
                            <div class="card-body">
                                <form id="emailForm">
                                    <div class="mb-3">
                                        <label class="form-label">件名</label>
                                        <input type="text" class="form-control" id="emailSubject"
                                               value="【スケジュール確認】港区ワンルーム原状回復 - 工事期間3日間">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">宛先</label>
                                        <input type="email" class="form-control" id="emailTo"
                                               value="tanaka@example.com" readonly>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">メール本文</label>
                                        <textarea class="form-control" id="emailBody" rows="12">田中様

いつもお世話になっております。
建築派遣SaaSの山田です。

新規案件についてスケジュール確認のご相談があります。

■案件詳細
案件番号: #P2025-0915-001
物件名: 港区ワンルーム原状回復
住所: 港区芝浦2-3-15 マンション芝浦 203号室
工事内容: クロス張替え（約35㎡）、ハウスクリーニング
希望工期: 3日間
希望完了日: 2025年9月25日
緊急度: 急ぎ

■確認事項
1. 上記期間での対応可否
2. ご希望の工事開始日
3. 作業時間帯のご希望
4. 駐車場の必要性
5. その他ご質問・ご要望

お忙しい中恐縮ですが、9月18日（水）までにご回答いただけますでしょうか。

よろしくお願いいたします。

建築派遣SaaS
山田 太郎
TEL: 03-1234-5678
Email: yamada@example.com</textarea>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <button type="button" class="btn btn-outline-primary w-100" onclick="showEmailPreview()">
                                                <i class="fas fa-eye me-1"></i>プレビュー
                                            </button>
                                        </div>
                                        <div class="col-md-6">
                                            <button type="button" class="btn btn-primary w-100" onclick="sendEmail()">
                                                <i class="fas fa-paper-plane me-1"></i>メール送信
                                            </button>
                                        </div>
                                    </div>
                                </form>

                                <!-- メールプレビュー -->
                                <div id="emailPreview" class="mt-3" style="display: none;">
                                    <hr>
                                    <h6>プレビュー</h6>
                                    <div class="email-preview" id="previewContent"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 職人からの回答入力エリア -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-reply me-2"></i>職人からの回答
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">対応可否</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="response" id="response1" value="available">
                                            <label class="form-check-label" for="response1">対応可能</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="response" id="response2" value="unavailable">
                                            <label class="form-check-label" for="response2">対応不可</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="response" id="response3" value="conditional">
                                            <label class="form-check-label" for="response3">条件付き対応可能</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">希望工事開始日</label>
                                            <input type="date" class="form-control" id="preferredStartDate">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">希望工事終了日</label>
                                            <input type="date" class="form-control" id="preferredEndDate">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">希望単価・工賃</label>
                                            <div class="input-group">
                                                <span class="input-group-text">¥</span>
                                                <input type="number" class="form-control" placeholder="80000">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">材料手配</label>
                                            <select class="form-select">
                                                <option value="">選択してください</option>
                                                <option value="self">自分で手配可能</option>
                                                <option value="support">手配サポート希望</option>
                                                <option value="company">会社手配希望</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="needParking">
                                        <label class="form-check-label" for="needParking">
                                            駐車場が必要
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">特記事項・要望</label>
                                    <textarea class="form-control" rows="4" placeholder="工事上の注意点、必要な準備、その他要望や質問があればご記入ください"></textarea>
                                </div>

                                <div class="d-grid">
                                    <button type="button" class="btn btn-success" onclick="saveResponse()">
                                        <i class="fas fa-save me-1"></i>回答を保存
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 右カラム: スケジュール表示 & 進捗管理 -->
                    <div class="col-md-3">
                        <!-- 進捗管理エリア -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-tasks me-2"></i>進捗状況
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="progress-timeline">
                                    <div class="timeline-item">
                                        <small class="text-muted">9/15 14:30</small>
                                        <div class="fw-bold">連絡送信</div>
                                        <small>メール送信完了</small>
                                    </div>
                                    <div class="timeline-item pending">
                                        <small class="text-muted">待機中</small>
                                        <div class="fw-bold">職人回答</div>
                                        <small>回答期限: 9/18</small>
                                    </div>
                                    <div class="timeline-item inactive">
                                        <small class="text-muted">未完了</small>
                                        <div>アサイン決定</div>
                                    </div>
                                    <div class="timeline-item inactive">
                                        <small class="text-muted">未完了</small>
                                        <div>工事開始</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 回答状況サマリー -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-pie me-2"></i>回答状況
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    <h2 class="text-primary">1/3</h2>
                                    <small class="text-muted">回答済み職人</small>
                                </div>

                                <div class="mb-2">
                                    <span class="badge bg-success">田中太郎</span>
                                    <small class="text-muted ms-2">回答済み</small>
                                </div>
                                <div class="mb-2">
                                    <span class="badge bg-warning">佐藤花子</span>
                                    <small class="text-muted ms-2">未回答</small>
                                </div>
                                <div class="mb-2">
                                    <span class="badge bg-warning">鈴木一郎</span>
                                    <small class="text-muted ms-2">未回答</small>
                                </div>
                            </div>
                        </div>

                        <!-- アクションボタン -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-bolt me-2"></i>次のアクション
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary btn-sm">
                                        <i class="fas fa-check me-1"></i>アサイン決定
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm">
                                        <i class="fas fa-clock me-1"></i>催促連絡
                                    </button>
                                    <button class="btn btn-outline-info btn-sm">
                                        <i class="fas fa-users me-1"></i>追加職人に連絡
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-save me-1"></i>下書き保存
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- スケジュールカレンダーエリア（全幅） -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>スケジュールカレンダー
                        </h5>
                        <button class="btn btn-success btn-sm" onclick="openAddScheduleModal()">
                            <i class="fas fa-plus me-1"></i>日程追加
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="changeMonth(-1)">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <h6 class="mb-0" id="currentMonth">2025年9月</h6>
                                    <button class="btn btn-outline-secondary btn-sm ms-2" onclick="changeMonth(1)">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <small class="text-muted">
                                    <span class="me-3"><span style="color: #ff9800;">■</span> 既存予定</span>
                                    <span class="me-3"><span style="color: #2196f3;">■</span> 選択日</span>
                                    <span><span style="color: #ffebee;">■</span> 土日</span>
                                </small>
                            </div>
                        </div>

                        <div class="calendar-grid mb-3" id="calendar">
                            <!-- カレンダーはJavaScriptで生成 -->
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <h6>選択した日程</h6>
                                <div id="selectedDates" class="border rounded p-2 min-height-60">
                                    <small class="text-muted">対応可能日をカレンダーから選択してください</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>時間帯指定</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="timeSlot" id="fullDay" value="fullDay" checked>
                                    <label class="form-check-label" for="fullDay">終日対応可能</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="timeSlot" id="morning" value="morning">
                                    <label class="form-check-label" for="morning">午前のみ（9:00-12:00）</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="timeSlot" id="afternoon" value="afternoon">
                                    <label class="form-check-label" for="afternoon">午後のみ（13:00-17:00）</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="timeSlot" id="custom" value="custom">
                                    <label class="form-check-label" for="custom">時間指定</label>
                                </div>
                                <div class="mt-2" id="customTimeInputs" style="display: none;">
                                    <div class="row">
                                        <div class="col-6">
                                            <input type="time" class="form-control form-control-sm" value="09:00">
                                        </div>
                                        <div class="col-6">
                                            <input type="time" class="form-control form-control-sm" value="17:00">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 日程追加モーダル -->
    <div class="modal fade" id="addScheduleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-calendar-plus me-2"></i>職人の日程追加
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addScheduleForm">
                        <div class="mb-3">
                            <label class="form-label">対象職人</label>
                            <input type="text" class="form-control" id="targetCraftsman" readonly>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">日付</label>
                            <input type="date" class="form-control" id="scheduleDate" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ステータス</label>
                            <select class="form-select" id="scheduleStatus" required>
                                <option value="">選択してください</option>
                                <option value="busy">作業予定（忙しい）</option>
                                <option value="available">対応可能</option>
                            </select>
                        </div>

                        <div class="mb-3" id="projectNameField" style="display: none;">
                            <label class="form-label">案件名</label>
                            <input type="text" class="form-control" id="projectName" placeholder="例：A案件（クロス張替え）">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">備考</label>
                            <textarea class="form-control" id="scheduleNote" rows="3" placeholder="必要に応じて追加情報を入力"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>キャンセル
                    </button>
                    <button type="button" class="btn btn-success" onclick="addScheduleEntry()">
                        <i class="fas fa-plus me-1"></i>日程を追加
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // カレンダー表示用の変数
        let currentDate = new Date();
        let selectedDates = [];
        let selectedCraftsman = null;

        // 職人ごとの日程データ
        const craftsmanScheduleData = {
            '1': { // 田中太郎
                name: '田中太郎',
                busyDates: ['2025-09-18', '2025-09-19', '2025-09-23', '2025-09-24', '2025-09-25'],
                availableDates: ['2025-09-20', '2025-09-21', '2025-09-22', '2025-09-26', '2025-09-27', '2025-09-28'],
                projects: {
                    '2025-09-18': 'A案件（クロス張替え）',
                    '2025-09-19': 'A案件（クロス張替え）',
                    '2025-09-23': 'B案件（原状回復）',
                    '2025-09-24': 'B案件（原状回復）',
                    '2025-09-25': 'B案件（原状回復）'
                }
            },
            '2': { // 佐藤次郎
                name: '佐藤次郎',
                busyDates: ['2025-09-20', '2025-09-24', '2025-09-25'],
                availableDates: ['2025-09-21', '2025-09-22', '2025-09-23', '2025-09-26', '2025-09-27', '2025-09-28'],
                projects: {
                    '2025-09-20': 'C案件（クリーニング）',
                    '2025-09-24': 'D案件（ハウスクリーニング）',
                    '2025-09-25': 'D案件（ハウスクリーニング）'
                }
            },
            '3': { // 鈴木三郎
                name: '鈴木三郎',
                busyDates: ['2025-09-18', '2025-09-19', '2025-09-20', '2025-09-26'],
                availableDates: ['2025-09-21', '2025-09-22', '2025-09-23', '2025-09-24', '2025-09-25', '2025-09-27', '2025-09-28'],
                projects: {
                    '2025-09-18': 'E案件（水道工事）',
                    '2025-09-19': 'E案件（水道工事）',
                    '2025-09-20': 'E案件（水道工事）',
                    '2025-09-26': 'F案件（配管修理）'
                }
            },
            '4': { // 高橋美咲
                name: '高橋美咲',
                busyDates: ['2025-09-21', '2025-09-22', '2025-09-27'],
                availableDates: ['2025-09-18', '2025-09-19', '2025-09-20', '2025-09-23', '2025-09-24', '2025-09-25', '2025-09-26', '2025-09-28'],
                projects: {
                    '2025-09-21': 'G案件（総合工事）',
                    '2025-09-22': 'G案件（総合工事）',
                    '2025-09-27': 'H案件（原状回復）'
                }
            },
            '5': { // 山田健一
                name: '山田健一',
                busyDates: ['2025-09-22', '2025-09-23', '2025-09-24'],
                availableDates: ['2025-09-18', '2025-09-19', '2025-09-20', '2025-09-21', '2025-09-25', '2025-09-26', '2025-09-27', '2025-09-28'],
                projects: {
                    '2025-09-22': 'I案件（クロス張替え）',
                    '2025-09-23': 'I案件（クロス張替え）',
                    '2025-09-24': 'I案件（クロス張替え）'
                }
            },
            '6': { // 吉田優子
                name: '吉田優子',
                busyDates: ['2025-09-18', '2025-09-24', '2025-09-25'],
                availableDates: ['2025-09-19', '2025-09-20', '2025-09-21', '2025-09-22', '2025-09-23', '2025-09-26', '2025-09-27', '2025-09-28'],
                projects: {
                    '2025-09-18': 'J案件（エコクリーニング）',
                    '2025-09-24': 'K案件（特殊清掃）',
                    '2025-09-25': 'K案件（特殊清掃）'
                }
            },
            '7': { // 中村一樹
                name: '中村一樹',
                busyDates: ['2025-09-19', '2025-09-20', '2025-09-23'],
                availableDates: ['2025-09-18', '2025-09-21', '2025-09-22', '2025-09-24', '2025-09-25', '2025-09-26', '2025-09-27', '2025-09-28'],
                projects: {
                    '2025-09-19': 'L案件（配管設備）',
                    '2025-09-20': 'L案件（配管設備）',
                    '2025-09-23': 'M案件（水道修理）'
                }
            },
            '8': { // 小林秀雄
                name: '小林秀雄',
                busyDates: ['2025-09-21', '2025-09-26', '2025-09-28'],
                availableDates: ['2025-09-18', '2025-09-19', '2025-09-20', '2025-09-22', '2025-09-23', '2025-09-24', '2025-09-25', '2025-09-27'],
                projects: {
                    '2025-09-21': 'N案件（多摩地区）',
                    '2025-09-26': 'O案件（郊外案件）',
                    '2025-09-28': 'P案件（移動作業）'
                }
            }
        };

        // ページ読み込み時にカレンダーを初期化
        document.addEventListener('DOMContentLoaded', function() {
            // URLパラメータから職人IDを取得
            const urlParams = new URLSearchParams(window.location.search);
            const craftsmanId = urlParams.get('craftsman') || '1';

            // sessionStorageからも職人情報を取得
            const savedCraftsman = sessionStorage.getItem('selectedCraftsman');
            if (savedCraftsman) {
                const craftsmanData = JSON.parse(savedCraftsman);
                selectedCraftsman = craftsmanData.id || craftsmanId;
            } else {
                selectedCraftsman = craftsmanId;
            }

            console.log('選択された職人ID:', selectedCraftsman);
            loadCraftsmanInfo(selectedCraftsman);
            generateCalendar();

            // 時間指定ラジオボタンの処理
            document.querySelectorAll('input[name="timeSlot"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const customInputs = document.getElementById('customTimeInputs');
                    if (this.value === 'custom') {
                        customInputs.style.display = 'block';
                    } else {
                        customInputs.style.display = 'none';
                    }
                });
            });
        });

        // 職人情報を読み込む
        function loadCraftsmanInfo(craftsmanId) {
            const craftsmanData = craftsmanScheduleData[craftsmanId];
            if (craftsmanData) {
                // 職人名を表示
                const craftsmanNameElements = document.querySelectorAll('.craftsman-name');
                craftsmanNameElements.forEach(element => {
                    element.textContent = craftsmanData.name;
                });

                console.log(`${craftsmanData.name}の日程データを読み込みました`);
            } else {
                console.warn('職人データが見つかりません:', craftsmanId);
            }
        }

        // カレンダー生成
        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            const monthTitle = document.getElementById('currentMonth');

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            monthTitle.textContent = `${year}年${month + 1}月`;

            // カレンダーのHTML生成
            let calendarHTML = '';

            // 曜日ヘッダー
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            weekdays.forEach(day => {
                calendarHTML += `<div class="calendar-day text-center fw-bold" style="background-color: #f8f9fa;">${day}</div>`;
            });

            // 月の最初の日と最後の日
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            // カレンダーの日付生成（6週間分）
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);

                const isCurrentMonth = date.getMonth() === month;
                const isToday = date.toDateString() === new Date().toDateString();
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const dateStr = formatDate(date);
                const isSelected = selectedDates.includes(dateStr);

                let classes = 'calendar-day text-center';
                if (!isCurrentMonth) classes += ' unavailable';
                if (isToday) classes += ' today';
                if (isWeekend && isCurrentMonth) classes += ' weekend';
                if (isSelected) classes += ' selected';

                // 職人の日程情報をチェック
                let scheduleInfo = '';
                if (isCurrentMonth && selectedCraftsman && craftsmanScheduleData[selectedCraftsman]) {
                    const craftsmanData = craftsmanScheduleData[selectedCraftsman];

                    // 忙しい日をチェック
                    if (craftsmanData.busyDates.includes(dateStr)) {
                        classes += ' craftsman-busy';
                        const projectName = craftsmanData.projects[dateStr] || '作業予定';
                        scheduleInfo = `<div class="schedule-info busy">${projectName}</div>`;
                    }
                    // 空いている日をチェック
                    else if (craftsmanData.availableDates.includes(dateStr)) {
                        classes += ' craftsman-available';
                        scheduleInfo = '<div class="schedule-info available">対応可能</div>';
                    }
                }

                let content = `<div class="${classes}" onclick="toggleDate('${dateStr}')"`;
                if (!isCurrentMonth) content += ' style="pointer-events: none;"';
                content += `>`;
                content += `<div>${date.getDate()}</div>`;
                content += scheduleInfo;

                content += '</div>';

                calendarHTML += content;
            }

            calendar.innerHTML = calendarHTML;
        }

        // 月を変更
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar();
        }

        // 日付の選択/解除
        function toggleDate(dateStr) {
            const index = selectedDates.indexOf(dateStr);
            if (index > -1) {
                selectedDates.splice(index, 1);
            } else {
                selectedDates.push(dateStr);
            }
            generateCalendar();
            updateSelectedDatesDisplay();
        }

        // 選択した日付の表示更新
        function updateSelectedDatesDisplay() {
            const container = document.getElementById('selectedDates');
            if (selectedDates.length === 0) {
                container.innerHTML = '<small class="text-muted">対応可能日をカレンダーから選択してください</small>';
            } else {
                const sortedDates = selectedDates.sort();
                container.innerHTML = sortedDates.map(date =>
                    `<span class="badge bg-primary me-1 mb-1">${date}</span>`
                ).join('');
            }
        }

        // 日付のフォーマット
        function formatDate(date) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}/${day}`;
        }

        // メールプレビュー表示
        function showEmailPreview() {
            const preview = document.getElementById('emailPreview');
            const content = document.getElementById('previewContent');
            const subject = document.getElementById('emailSubject').value;
            const to = document.getElementById('emailTo').value;
            const body = document.getElementById('emailBody').value;

            content.innerHTML = `件名: ${subject}\n宛先: ${to}\n\n${body}`;
            preview.style.display = 'block';
        }

        // メール送信
        function sendEmail() {
            if (confirm('メールを送信しますか？')) {
                // 実際の送信処理をここに実装
                alert('メールを送信しました。');

                // 進捗状況を更新
                updateProgress('メール送信完了');
            }
        }

        // 職人回答を保存
        function saveResponse() {
            if (confirm('回答内容を保存しますか？')) {
                // 実際の保存処理をここに実装
                alert('回答を保存しました。');

                // 進捗状況を更新
                updateProgress('職人回答受領');
            }
        }

        // 進捗状況更新
        function updateProgress(status) {
            console.log('進捗更新:', status);
            // 実際の進捗更新処理をここに実装
        }

        // メール作成エリアにスクロール
        function scrollToEmail() {
            document.getElementById('email-section').scrollIntoView({
                behavior: 'smooth'
            });
        }

        // 日程追加モーダルを開く
        function openAddScheduleModal() {
            const modal = new bootstrap.Modal(document.getElementById('addScheduleModal'));

            // 職人名を設定
            if (selectedCraftsman && craftsmanScheduleData[selectedCraftsman]) {
                document.getElementById('targetCraftsman').value = craftsmanScheduleData[selectedCraftsman].name;
            }

            // 今日の日付を初期値に設定
            document.getElementById('scheduleDate').value = new Date().toISOString().split('T')[0];

            // フォームをリセット
            document.getElementById('scheduleStatus').value = '';
            document.getElementById('projectName').value = '';
            document.getElementById('scheduleNote').value = '';
            document.getElementById('projectNameField').style.display = 'none';

            modal.show();
        }

        // ステータス変更時の処理
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('scheduleStatus').addEventListener('change', function() {
                const projectNameField = document.getElementById('projectNameField');
                if (this.value === 'busy') {
                    projectNameField.style.display = 'block';
                    document.getElementById('projectName').required = true;
                } else {
                    projectNameField.style.display = 'none';
                    document.getElementById('projectName').required = false;
                }
            });
        });

        // 日程エントリーを追加
        function addScheduleEntry() {
            const scheduleDate = document.getElementById('scheduleDate').value;
            const scheduleStatus = document.getElementById('scheduleStatus').value;
            const projectName = document.getElementById('projectName').value;
            const scheduleNote = document.getElementById('scheduleNote').value;

            // バリデーション
            if (!scheduleDate || !scheduleStatus) {
                alert('日付とステータスは必須です。');
                return;
            }

            if (scheduleStatus === 'busy' && !projectName) {
                alert('作業予定の場合、案件名を入力してください。');
                return;
            }

            // 日付のフォーマット変換（YYYY-MM-DD → YYYY-MM-DD）
            const formattedDate = scheduleDate;

            // 職人データに追加
            if (selectedCraftsman && craftsmanScheduleData[selectedCraftsman]) {
                const craftsmanData = craftsmanScheduleData[selectedCraftsman];

                // 既存の日程から削除（重複を避ける）
                const busyIndex = craftsmanData.busyDates.indexOf(formattedDate);
                const availableIndex = craftsmanData.availableDates.indexOf(formattedDate);

                if (busyIndex > -1) {
                    craftsmanData.busyDates.splice(busyIndex, 1);
                    delete craftsmanData.projects[formattedDate];
                }
                if (availableIndex > -1) {
                    craftsmanData.availableDates.splice(availableIndex, 1);
                }

                // 新しい日程を追加
                if (scheduleStatus === 'busy') {
                    craftsmanData.busyDates.push(formattedDate);
                    craftsmanData.projects[formattedDate] = projectName;
                } else if (scheduleStatus === 'available') {
                    craftsmanData.availableDates.push(formattedDate);
                }

                // カレンダーを再生成
                generateCalendar();

                // モーダルを閉じる
                const modal = bootstrap.Modal.getInstance(document.getElementById('addScheduleModal'));
                modal.hide();

                // 成功メッセージ
                alert(`${craftsmanData.name}の日程を追加しました: ${formattedDate}`);

                console.log('日程追加完了:', {
                    craftsman: craftsmanData.name,
                    date: formattedDate,
                    status: scheduleStatus,
                    project: projectName,
                    note: scheduleNote
                });
            } else {
                alert('職人データの取得に失敗しました。');
            }
        }

        // 今日の日付を設定
        document.getElementById('preferredStartDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('preferredEndDate').value = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    </script>
</body>
</html>