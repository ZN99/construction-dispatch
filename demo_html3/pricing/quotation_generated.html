<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>見積書生成完了 - 建築派遣SaaS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../css/quotation_workflow.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif;
        }
        .header-section {
            background: linear-gradient(135deg, #20c997, #17a2b8);
            color: white;
            padding: 30px 0;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(32, 201, 151, 0.3);
        }
        .success-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        .quotation-preview {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
        }
        .quotation-header {
            text-align: center;
            border-bottom: 2px solid #20c997;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .quotation-company {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }
        .quotation-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #20c997;
            margin: 15px 0;
        }
        .quotation-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .quotation-table {
            margin: 30px 0;
        }
        .quotation-table th {
            background: #e9f7ef;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 12px;
            text-align: center;
        }
        .quotation-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            vertical-align: middle;
        }
        .total-row {
            background: #20c997;
            color: white;
            font-weight: bold;
        }
        .action-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .action-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .action-card:hover {
            border-color: #20c997;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(32, 201, 151, 0.2);
        }
        .action-card .icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #20c997);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(23, 162, 184, 0.3);
        }
        .workflow-complete {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }
        .print-view {
            background: white;
            margin: 20px 0;
            display: none;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .print-view, .print-view * {
                visibility: visible;
            }
            .print-view {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block !important;
            }
            .no-print {
                display: none !important;
            }
        }
        .approval-status {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .next-steps {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="header-section">
        <div class="container text-center">
            <div class="success-badge">
                <i class="bi bi-check-circle"></i> 見積書生成完了
            </div>
            <h2>賃貸原状回復工事 見積書</h2>
            <p class="mb-0">お客様への提出準備が整いました</p>
        </div>
    </div>

    <div class="container">
        <!-- Workflow Complete -->
        <div class="workflow-complete">
            <div class="workflow-progress mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-white mb-0">見積作成ワークフロー</h6>
                    <span class="badge bg-light text-dark">完了</span>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-light" role="progressbar" style="width: 100%"></div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-white-50">現地調査</small>
                    <small class="text-white-50">材料費入力</small>
                    <small class="text-white-50">マージン設定</small>
                    <small class="text-white">見積生成</small>
                </div>
            </div>
            <h4><i class="bi bi-trophy"></i> 全工程完了</h4>
            <p class="mb-0">見積作成ワークフローが正常に完了しました</p>
        </div>

        <!-- Quotation Preview -->
        <div class="quotation-preview" id="quotationPreview">
            <div class="quotation-header">
                <div class="quotation-company">株式会社 建築派遣プロ</div>
                <div class="quotation-title">賃貸原状回復工事 見積書</div>
                <div class="text-muted">見積番号: EST-2024-<span id="quotationNumber">0001</span></div>
            </div>

            <div class="quotation-info">
                <div class="row">
                    <div class="col-md-6">
                        <h6>お客様情報</h6>
                        <div id="customerInfo">
                            <div>〒150-0001</div>
                            <div>東京都渋谷区神宮前1-1-1</div>
                            <div>田中不動産 様</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>工事概要</h6>
                        <div id="workInfo">
                            <div><strong>物件:</strong> <span id="propertyDetails">1DK マンション</span></div>
                            <div><strong>作業:</strong> <span id="workTypeDetails">複合作業（クリーニング・壁紙・設備）</span></div>
                            <div><strong>面積:</strong> <span id="areaDetails">床面積 25.2㎡</span></div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div><strong>見積日:</strong> <span id="quotationDate">2024年1月15日</span></div>
                    </div>
                    <div class="col-md-6">
                        <div><strong>有効期限:</strong> <span id="validUntil">2024年2月15日</span></div>
                    </div>
                </div>
            </div>

            <table class="table quotation-table">
                <thead>
                    <tr>
                        <th style="width: 40%">工事項目</th>
                        <th style="width: 15%">数量</th>
                        <th style="width: 15%">単位</th>
                        <th style="width: 15%">単価</th>
                        <th style="width: 15%">金額</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>クリーニング作業</strong><br><small class="text-muted">居室・水回り清掃一式</small></td>
                        <td class="text-center">1</td>
                        <td class="text-center">式</td>
                        <td class="text-end">¥25,000</td>
                        <td class="text-end">¥25,000</td>
                    </tr>
                    <tr>
                        <td><strong>壁紙貼り替え工事</strong><br><small class="text-muted">ビニールクロス貼り替え</small></td>
                        <td class="text-center" id="wallpaperQty">45.5</td>
                        <td class="text-center">㎡</td>
                        <td class="text-end">¥1,200</td>
                        <td class="text-end" id="wallpaperAmount">¥54,600</td>
                    </tr>
                    <tr>
                        <td><strong>水道設備工事</strong><br><small class="text-muted">水栓交換・配管補修</small></td>
                        <td class="text-center">1</td>
                        <td class="text-center">式</td>
                        <td class="text-end">¥45,000</td>
                        <td class="text-end">¥45,000</td>
                    </tr>
                    <tr>
                        <td><strong>諸経費</strong><br><small class="text-muted">交通費・管理費・保険料等</small></td>
                        <td class="text-center">1</td>
                        <td class="text-center">式</td>
                        <td class="text-end">¥20,000</td>
                        <td class="text-end">¥20,000</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="4" class="text-center"><strong>合計金額（税抜）</strong></td>
                        <td class="text-end"><strong id="subtotalAmount">¥144,600</strong></td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="4" class="text-center"><strong>消費税（10%）</strong></td>
                        <td class="text-end"><strong id="taxAmount">¥14,460</strong></td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="4" class="text-center"><strong>総合計金額（税込）</strong></td>
                        <td class="text-end"><strong id="totalAmount">¥159,060</strong></td>
                    </tr>
                </tfoot>
            </table>

            <div class="quotation-info">
                <h6>工事条件・注意事項</h6>
                <ul>
                    <li>上記金額は現地調査に基づく概算金額です</li>
                    <li>工事開始前の最終確認により、金額が変更される場合があります</li>
                    <li>工事期間：3-5営業日を予定しております</li>
                    <li>材料費の高騰により、価格が変動する場合があります</li>
                    <li>廃材処分費・駐車場代は別途実費となります</li>
                </ul>
            </div>

            <div class="text-center mt-4">
                <div class="quotation-company">株式会社 建築派遣プロ</div>
                <div>〒100-0001 東京都千代田区千代田1-1-1</div>
                <div>TEL: 03-1234-5678 / FAX: 03-1234-5679</div>
                <div>担当: <span id="staffName">田中 太郎</span></div>
            </div>
        </div>

        <!-- Approval Status -->
        <div class="approval-status">
            <h6><i class="bi bi-shield-check text-success"></i> 承認完了状況</h6>
            <div class="row">
                <div class="col-md-6">
                    <strong>マージン・価格承認:</strong>
                    <span class="badge bg-success">承認済み</span>
                </div>
                <div class="col-md-6">
                    <strong>見積書生成:</strong>
                    <span class="badge bg-success">完了</span>
                </div>
            </div>
            <div class="mt-3">
                <div class="approval-details p-3 bg-light border rounded">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>承認者:</strong> <span id="approverName">田中 太郎（社員）</span><br>
                            <strong>承認日時:</strong> <span id="approvalDateTime">2024-01-15 16:30</span>
                        </div>
                        <div class="col-md-6">
                            <strong>最終価格:</strong> <span id="approvedPrice" class="text-success fw-bold">¥159,060</span><br>
                            <strong>マージン率:</strong> <span id="approvedMargin">35.0%</span>
                        </div>
                    </div>
                    <div class="mt-2">
                        <strong>承認コメント:</strong>
                        <div id="approvalComment" class="mt-1 p-2 border bg-white rounded">
                            市場価格と比較して競争力のある価格設定です。利益率も適正範囲内であり、承認いたします。
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Next Steps -->
        <div class="next-steps">
            <h6><i class="bi bi-arrow-right-circle text-primary"></i> 次のステップ</h6>
            <ol>
                <li><strong>見積書確認:</strong> 内容に間違いがないか最終確認</li>
                <li><strong>顧客送付:</strong> PDFまたは印刷版でお客様へ提出</li>
                <li><strong>回答待機:</strong> お客様からの回答をお待ちください</li>
                <li><strong>受注処理:</strong> 受注確定時は工事スケジュール調整へ</li>
            </ol>
        </div>

        <!-- Action Cards -->
        <div class="action-cards">
            <div class="action-card" onclick="previewQuotation()">
                <i class="bi bi-eye icon text-primary"></i>
                <h6>見積書プレビュー</h6>
                <p class="text-muted">印刷レイアウトで確認</p>
            </div>

            <div class="action-card" onclick="downloadPDF()">
                <i class="bi bi-file-earmark-pdf icon text-danger"></i>
                <h6>PDF出力</h6>
                <p class="text-muted">顧客送付用PDF作成</p>
            </div>

            <div class="action-card" onclick="sendEmail()">
                <i class="bi bi-envelope icon text-success"></i>
                <h6>メール送信</h6>
                <p class="text-muted">顧客へ直接送信</p>
            </div>

            <div class="action-card" onclick="editQuotation()">
                <i class="bi bi-pencil icon text-warning"></i>
                <h6>見積修正</h6>
                <p class="text-muted">内容の修正・調整</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mt-4 mb-4">
            <div class="col-md-4">
                <button type="button" class="btn btn-outline-primary w-100" onclick="copyQuotation()">
                    <i class="bi bi-clipboard"></i> 見積複製
                </button>
            </div>
            <div class="col-md-4">
                <button type="button" class="btn btn-info w-100" onclick="goToApproval()">
                    <i class="bi bi-shield-check"></i> 承認履歴
                </button>
            </div>
            <div class="col-md-4">
                <button type="button" class="btn btn-success w-100" onclick="goToDashboard()">
                    <i class="bi bi-house"></i> ダッシュボード
                </button>
            </div>
        </div>
    </div>

    <!-- Print View (Hidden) -->
    <div class="print-view" id="printView">
        <div id="printContent"></div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-check-circle"></i> 操作完了</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="modalMessage">操作が正常に完了しました。</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">確認</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/quotation_workflow.js"></script>
    <script>
        class QuotationGenerated {
            constructor() {
                this.workflow = new QuotationWorkflow();
                this.quotationData = null;
                this.initializeApp();
            }

            initializeApp() {
                this.validateAccess();
                this.loadQuotationData();
                this.generateQuotationNumber();
                this.setupQuotationContent();
                this.markWorkflowComplete();
            }

            validateAccess() {
                const userRole = this.workflow.getUserRole();
                if (userRole !== 'employee') {
                    alert('この画面は社員専用です。');
                    window.location.href = '../index_manager.html';
                    return;
                }
            }

            loadQuotationData() {
                // Load workflow data
                const surveyData = this.workflow.getCurrentSurveyData();
                const materialData = this.workflow.getCurrentMaterialCosts();
                const marginData = this.workflow.getCurrentMarginSettings();

                this.quotationData = {
                    survey: surveyData,
                    materials: materialData,
                    margins: marginData,
                    generatedAt: new Date().toISOString(),
                    quotationNumber: this.generateQuotationNumber(),
                    status: 'generated'
                };

                // Save complete quotation data
                this.workflow.saveCompletedQuotation(this.quotationData);
            }

            generateQuotationNumber() {
                const now = new Date();
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const date = now.getDate().toString().padStart(2, '0');
                const sequence = Math.floor(Math.random() * 9999).toString().padStart(4, '0');

                const quotationNum = `${year}${month}${date}${sequence}`;
                document.getElementById('quotationNumber').textContent = quotationNum;
                return quotationNum;
            }

            setupQuotationContent() {
                // Set dates
                const today = new Date();
                const validUntil = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000); // +30 days

                document.getElementById('quotationDate').textContent =
                    today.toLocaleDateString('ja-JP', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                document.getElementById('validUntil').textContent =
                    validUntil.toLocaleDateString('ja-JP', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                // Set approval time
                document.getElementById('approvalDateTime').textContent =
                    today.toLocaleString('ja-JP');

                // Set staff name
                const user = this.workflow.getCurrentUser();
                document.getElementById('staffName').textContent = user.name || '担当者';
                document.getElementById('approverName').textContent = `${user.name || '担当者'}（社員）`;

                // Load survey data if available
                if (this.quotationData.survey) {
                    this.updatePropertyDetails(this.quotationData.survey);
                }

                // Load pricing data if available
                if (this.quotationData.materials && this.quotationData.margins) {
                    this.updatePricingDetails(this.quotationData.materials, this.quotationData.margins);
                }

                // Load approval data if available
                if (this.quotationData.margins && this.quotationData.margins.approval) {
                    this.updateApprovalDetails(this.quotationData.margins.approval);
                }
            }

            updatePropertyDetails(surveyData) {
                if (surveyData.propertyType) {
                    document.getElementById('propertyDetails').textContent =
                        `${surveyData.propertyType} マンション`;
                }

                if (surveyData.workType) {
                    const workTypeLabels = {
                        'cleaning': 'クリーニング作業',
                        'wallpaper': '壁紙貼り替え',
                        'plumbing': '水道設備工事',
                        'combined': '複合作業（クリーニング・壁紙・設備）'
                    };
                    document.getElementById('workTypeDetails').textContent =
                        workTypeLabels[surveyData.workType] || surveyData.workType;
                }

                if (surveyData.measurements) {
                    document.getElementById('areaDetails').textContent =
                        `床面積 ${surveyData.measurements.floorArea.toFixed(1)}㎡`;

                    // Update wallpaper quantity
                    document.getElementById('wallpaperQty').textContent =
                        surveyData.measurements.wallArea.toFixed(1);

                    // Recalculate wallpaper amount
                    const wallpaperAmount = surveyData.measurements.wallArea * 1200;
                    document.getElementById('wallpaperAmount').textContent =
                        `¥${wallpaperAmount.toLocaleString()}`;
                }
            }

            updatePricingDetails(materialData, marginData) {
                if (marginData && marginData.costBreakdown) {
                    const finalPrice = marginData.costBreakdown.finalPrice;
                    const subtotal = Math.round(finalPrice / 1.1); // Remove tax
                    const tax = finalPrice - subtotal;

                    document.getElementById('subtotalAmount').textContent = `¥${subtotal.toLocaleString()}`;
                    document.getElementById('taxAmount').textContent = `¥${tax.toLocaleString()}`;
                    document.getElementById('totalAmount').textContent = `¥${finalPrice.toLocaleString()}`;

                    // Update approval section pricing
                    document.getElementById('approvedPrice').textContent = `¥${finalPrice.toLocaleString()}`;
                    if (marginData.marginSettings) {
                        document.getElementById('approvedMargin').textContent = `${marginData.marginSettings.marginRate}%`;
                    }
                }
            }

            updateApprovalDetails(approvalData) {
                if (approvalData.approver) {
                    document.getElementById('approverName').textContent = `${approvalData.approver}（社員）`;
                }

                if (approvalData.approvalDateTime) {
                    document.getElementById('approvalDateTime').textContent =
                        new Date(approvalData.approvalDateTime).toLocaleString('ja-JP');
                }

                if (approvalData.approvalComment) {
                    document.getElementById('approvalComment').textContent = approvalData.approvalComment;
                }
            }

            markWorkflowComplete() {
                // Mark workflow as completed
                this.workflow.completeWorkflow();

                // Log completion
                this.workflow.logActivity('quotation_generated', {
                    quotationNumber: this.quotationData.quotationNumber,
                    finalPrice: this.quotationData.margins?.costBreakdown?.finalPrice || 0
                });

                // Show completion notification
                setTimeout(() => {
                    this.showSuccessMessage('見積書の生成が完了しました。');
                }, 1000);
            }

            showSuccessMessage(message) {
                document.getElementById('modalMessage').textContent = message;
                const modal = new bootstrap.Modal(document.getElementById('successModal'));
                modal.show();
            }

            generatePrintContent() {
                const printContent = document.getElementById('quotationPreview').cloneNode(true);
                printContent.querySelectorAll('.no-print').forEach(el => el.remove());
                return printContent.outerHTML;
            }
        }

        // Global functions
        function previewQuotation() {
            const printContent = app.generatePrintContent();
            document.getElementById('printContent').innerHTML = printContent;
            window.print();
        }

        function downloadPDF() {
            // In a real implementation, this would generate a PDF
            app.showSuccessMessage('PDF生成機能は開発中です。現在は印刷機能をご利用ください。');
        }

        function sendEmail() {
            // In a real implementation, this would open email client or sending interface
            app.showSuccessMessage('メール送信機能は開発中です。PDFをダウンロードしてお送りください。');
        }

        function editQuotation() {
            if (confirm('見積内容を修正しますか？承認プロセスが再度必要になります。')) {
                window.location.href = 'margin_setting.html';
            }
        }

        function copyQuotation() {
            // In a real implementation, this would create a copy for a new quotation
            app.showSuccessMessage('見積複製機能は開発中です。');
        }

        function goToApproval() {
            window.location.href = 'approval_history.html';
        }

        function goToDashboard() {
            window.location.href = '../index_manager.html';
        }

        // Initialize app
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new QuotationGenerated();
        });

        // Print styles
        window.addEventListener('beforeprint', () => {
            document.querySelectorAll('.no-print').forEach(el => {
                el.style.display = 'none';
            });
        });

        window.addEventListener('afterprint', () => {
            document.querySelectorAll('.no-print').forEach(el => {
                el.style.display = '';
            });
        });
    </script>
</body>
</html>