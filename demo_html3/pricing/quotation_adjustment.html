<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社員用見積調整画面 | 建築派遣SaaS</title>
    <link rel="stylesheet" href="../css/simple_theme.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Bootstrap互換性のため一部保持 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .adjustment-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .adjustment-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
        }
        .price-adjustment-row {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 10px;
            padding: 15px;
        }
        .original-price {
            color: #6c757d;
            text-decoration: line-through;
            font-size: 0.9em;
        }
        .adjusted-price {
            color: #198754;
            font-weight: bold;
            font-size: 1.1em;
        }
        .price-change {
            font-size: 0.85em;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .price-increase {
            background: #fff3cd;
            color: #664d03;
        }
        .price-decrease {
            background: #d1ecf1;
            color: #0c5460;
        }
        .approval-section {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }
        .profit-indicator {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
        }
        .profit-high {
            background: #d4edda;
            color: #155724;
        }
        .profit-medium {
            background: #fff3cd;
            color: #664d03;
        }
        .profit-low {
            background: #f8d7da;
            color: #721c24;
        }
        .comment-box {
            min-height: 100px;
            resize: vertical;
        }
        .status-badge {
            font-size: 0.8em;
            padding: 4px 12px;
            border-radius: 15px;
        }
        .btn-adjust {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            border: none;
            color: white;
        }
        .btn-adjust:hover {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
            color: white;
        }
        .btn-approve {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
        }
        .btn-approve:hover {
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
            color: white;
        }
        .adjustment-history {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
        }
        .history-item {
            border-bottom: 1px solid #dee2e6;
            padding: 10px 0;
        }
        .history-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);">
        <div class="container">
            <a class="navbar-brand" href="../index_manager.html">
                <i class="bi bi-building"></i> 建築派遣SaaS
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="bi bi-person-badge"></i> 社員: <span id="currentUser">管理者</span>
                </span>
                <a class="nav-link" href="../index_manager.html">
                    <i class="bi bi-house"></i> ホーム
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-clipboard-check"></i> 社員用見積調整画面</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="../index_manager.html">ホーム</a></li>
                            <li class="breadcrumb-item"><a href="surveyed_projects_list.html">物件一覧</a></li>
                            <li class="breadcrumb-item active">見積調整</li>
                        </ol>
                    </nav>
                </div>

                <div class="row">
                    <div class="col-md-8">
                        <div class="adjustment-card">
                            <div class="adjustment-header">
                                <h4><i class="bi bi-file-earmark-text"></i> 見積書詳細</h4>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <small class="text-muted">物件ID:</small>
                                        <span id="projectId" class="fw-bold">PRJ-001</span>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">ステータス:</small>
                                        <span id="projectStatus" class="badge status-badge bg-warning">調整待ち</span>
                                    </div>
                                </div>
                            </div>
                            <div class="p-3">
                                <div id="quotationDetails">
                                    <!-- 見積詳細がここに動的に表示される -->
                                </div>
                            </div>
                        </div>

                        <div class="adjustment-card">
                            <div class="adjustment-header">
                                <h5><i class="bi bi-calculator"></i> 価格調整</h5>
                            </div>
                            <div class="p-3">
                                <div id="adjustmentItems">
                                    <!-- 調整項目がここに動的に表示される -->
                                </div>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="quotationAdjustment.addCustomItem()">
                                        <i class="bi bi-plus-circle"></i> カスタム項目追加
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="adjustment-card">
                            <div class="adjustment-header">
                                <h5><i class="bi bi-chat-square-text"></i> 調整コメント</h5>
                            </div>
                            <div class="p-3">
                                <textarea id="adjustmentComment" class="form-control comment-box"
                                    placeholder="調整理由や特記事項を入力してください..."></textarea>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i>
                                        このコメントは見積書に添付され、顧客に送信されます。
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="adjustment-card">
                            <div class="adjustment-header">
                                <h5><i class="bi bi-graph-up"></i> 収益分析</h5>
                            </div>
                            <div class="p-3">
                                <div class="row text-center mb-3">
                                    <div class="col-12">
                                        <div id="profitIndicator" class="profit-indicator profit-medium">
                                            利益率: <span id="profitRate">18.5%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <div class="text-center">
                                            <small class="text-muted">原価</small>
                                            <div class="fw-bold" id="baseCost">¥850,000</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <small class="text-muted">売価</small>
                                            <div class="fw-bold text-success" id="sellingPrice">¥1,043,500</div>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-12">
                                        <small class="text-muted">利益額</small>
                                        <div class="fw-bold text-primary" id="profitAmount">¥193,500</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="adjustment-card">
                            <div class="adjustment-header">
                                <h5><i class="bi bi-clock-history"></i> 調整履歴</h5>
                            </div>
                            <div class="p-3">
                                <div id="adjustmentHistory" class="adjustment-history">
                                    <!-- 調整履歴がここに表示される -->
                                </div>
                            </div>
                        </div>

                        <div class="approval-section">
                            <h5><i class="bi bi-check-circle"></i> 承認・送信</h5>
                            <div class="mt-3">
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-adjust" onclick="quotationAdjustment.saveAdjustments()">
                                        <i class="bi bi-floppy"></i> 調整内容を保存
                                    </button>
                                    <button type="button" class="btn btn-approve" onclick="quotationAdjustment.approveQuotation()">
                                        <i class="bi bi-check-circle"></i> 見積承認・送信準備
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="quotationAdjustment.requestRevision()">
                                        <i class="bi bi-arrow-counterclockwise"></i> 再調整依頼
                                    </button>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-shield-check"></i>
                                    労働者派遣法第23条に基づく社員承認プロセス
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 調整項目追加モーダル -->
    <div class="modal fade" id="customItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">カスタム項目追加</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="customItemForm">
                        <div class="mb-3">
                            <label for="itemName" class="form-label">項目名</label>
                            <input type="text" class="form-control" id="itemName" required>
                        </div>
                        <div class="mb-3">
                            <label for="itemCategory" class="form-label">カテゴリ</label>
                            <select class="form-select" id="itemCategory" required>
                                <option value="">選択してください</option>
                                <option value="material">材料費</option>
                                <option value="labor">人件費</option>
                                <option value="equipment">設備費</option>
                                <option value="other">その他</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="itemPrice" class="form-label">金額</label>
                            <input type="number" class="form-control" id="itemPrice" required>
                        </div>
                        <div class="mb-3">
                            <label for="itemNote" class="form-label">備考</label>
                            <textarea class="form-control" id="itemNote" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="quotationAdjustment.saveCustomItem()">追加</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/simple_ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class QuotationAdjustmentSystem {
            constructor() {
                this.currentProject = null;
                this.adjustments = {};
                this.originalQuotation = null;
                this.currentUser = this.getCurrentUser();
                this.init();
            }

            async init() {
                this.loadProjectData();
                this.renderQuotationDetails();
                this.renderAdjustmentItems();
                this.renderAdjustmentHistory();
                this.calculateProfitMetrics();
                this.setupAutoSave();
                this.setupRolePermissions();
            }

            getCurrentUser() {
                return JSON.parse(localStorage.getItem('currentUser') || '{"name": "管理者", "role": "社員", "id": "EMP001"}');
            }

            loadProjectData() {
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('id') || 'PRJ-001';

                this.currentProject = JSON.parse(localStorage.getItem(`project_${projectId}`)) || {
                    id: projectId,
                    status: 'adjustment',
                    customerName: '山田太郎',
                    propertyAddress: '東京都渋谷区shibuya 1-1-1',
                    constructionType: 'kitchen',
                    autoQuotation: this.loadAutoQuotation(projectId)
                };

                document.getElementById('projectId').textContent = this.currentProject.id;
                document.getElementById('currentUser').textContent = this.currentUser.name;
            }

            loadAutoQuotation(projectId) {
                const autoQuotation = JSON.parse(localStorage.getItem(`auto_quotation_${projectId}`)) || {
                    baseCost: 850000,
                    marginRate: 22,
                    marginAmount: 187000,
                    quotationPrice: 1037000,
                    tax: 103700,
                    totalPrice: 1140700,
                    items: [
                        { name: 'キッチン解体工事', category: 'labor', price: 120000, adjustable: true },
                        { name: 'システムキッチン本体', category: 'material', price: 480000, adjustable: true },
                        { name: 'キッチン設置工事', category: 'labor', price: 180000, adjustable: true },
                        { name: '配管工事', category: 'equipment', price: 70000, adjustable: true }
                    ]
                };
                this.originalQuotation = JSON.parse(JSON.stringify(autoQuotation));
                return autoQuotation;
            }

            renderQuotationDetails() {
                const quotation = this.currentProject.autoQuotation;
                const detailsHtml = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>顧客名:</strong> ${this.currentProject.customerName}
                        </div>
                        <div class="col-md-6">
                            <strong>物件住所:</strong> ${this.currentProject.propertyAddress}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>工事種別:</strong> ${this.getConstructionTypeName(this.currentProject.constructionType)}
                        </div>
                        <div class="col-md-6">
                            <strong>見積作成日:</strong> ${new Date().toLocaleDateString('ja-JP')}
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <small class="text-muted">基本工事費</small>
                                <div class="h5">¥${quotation.baseCost.toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <small class="text-muted">マージン</small>
                                <div class="h5 text-primary">¥${quotation.marginAmount.toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <small class="text-muted">税込総額</small>
                                <div class="h5 text-success">¥${quotation.totalPrice.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('quotationDetails').innerHTML = detailsHtml;
            }

            renderAdjustmentItems() {
                const quotation = this.currentProject.autoQuotation;
                const itemsHtml = quotation.items.map((item, index) => {
                    const adjustment = this.adjustments[index] || { price: item.price, note: '' };
                    const priceChange = adjustment.price - item.price;
                    const changeClass = priceChange > 0 ? 'price-increase' : priceChange < 0 ? 'price-decrease' : '';

                    return `
                        <div class="price-adjustment-row">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <h6 class="mb-1">${item.name}</h6>
                                    <small class="text-muted">${this.getCategoryName(item.category)}</small>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">元価格</small>
                                    <div class="original-price">¥${item.price.toLocaleString()}</div>
                                    <input type="number" class="form-control form-control-sm mt-1"
                                        value="${adjustment.price}"
                                        onchange="quotationAdjustment.updateItemPrice(${index}, this.value)"
                                        ${!item.adjustable ? 'disabled' : ''}>
                                </div>
                                <div class="col-md-2">
                                    ${priceChange !== 0 ? `
                                        <span class="price-change ${changeClass}">
                                            ${priceChange > 0 ? '+' : ''}¥${priceChange.toLocaleString()}
                                        </span>
                                    ` : ''}
                                </div>
                                <div class="col-md-3">
                                    <textarea class="form-control form-control-sm"
                                        placeholder="調整理由..."
                                        onchange="quotationAdjustment.updateItemNote(${index}, this.value)"
                                        ${!item.adjustable ? 'disabled' : ''}>${adjustment.note}</textarea>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('adjustmentItems').innerHTML = itemsHtml;
            }

            updateItemPrice(index, newPrice) {
                const price = parseInt(newPrice) || 0;
                if (!this.adjustments[index]) {
                    this.adjustments[index] = {};
                }
                this.adjustments[index].price = price;

                this.renderAdjustmentItems();
                this.calculateProfitMetrics();
                this.saveAdjustments();
                this.addToHistory(`項目「${this.currentProject.autoQuotation.items[index].name}」の価格を¥${price.toLocaleString()}に調整`);
            }

            updateItemNote(index, note) {
                if (!this.adjustments[index]) {
                    this.adjustments[index] = {};
                }
                this.adjustments[index].note = note;
                this.saveAdjustments();
            }

            calculateProfitMetrics() {
                const quotation = this.currentProject.autoQuotation;
                let adjustedTotal = 0;

                quotation.items.forEach((item, index) => {
                    const adjustment = this.adjustments[index];
                    adjustedTotal += adjustment ? adjustment.price : item.price;
                });

                const adjustedMargin = adjustedTotal - quotation.baseCost;
                const adjustedTax = Math.round(adjustedTotal * 0.1);
                const adjustedTotalWithTax = adjustedTotal + adjustedTax;
                const profitRate = ((adjustedMargin / adjustedTotal) * 100).toFixed(1);

                document.getElementById('baseCost').textContent = `¥${quotation.baseCost.toLocaleString()}`;
                document.getElementById('sellingPrice').textContent = `¥${adjustedTotal.toLocaleString()}`;
                document.getElementById('profitAmount').textContent = `¥${adjustedMargin.toLocaleString()}`;
                document.getElementById('profitRate').textContent = `${profitRate}%`;

                const profitIndicator = document.getElementById('profitIndicator');
                profitIndicator.className = 'profit-indicator';
                if (profitRate >= 20) {
                    profitIndicator.classList.add('profit-high');
                } else if (profitRate >= 15) {
                    profitIndicator.classList.add('profit-medium');
                } else {
                    profitIndicator.classList.add('profit-low');
                }
            }

            addCustomItem() {
                const modal = new bootstrap.Modal(document.getElementById('customItemModal'));
                modal.show();
            }

            saveCustomItem() {
                const form = document.getElementById('customItemForm');
                const formData = new FormData(form);

                const customItem = {
                    name: document.getElementById('itemName').value,
                    category: document.getElementById('itemCategory').value,
                    price: parseInt(document.getElementById('itemPrice').value),
                    note: document.getElementById('itemNote').value,
                    adjustable: true,
                    custom: true
                };

                this.currentProject.autoQuotation.items.push(customItem);
                this.renderAdjustmentItems();
                this.calculateProfitMetrics();
                this.addToHistory(`カスタム項目「${customItem.name}」を追加`);

                form.reset();
                bootstrap.Modal.getInstance(document.getElementById('customItemModal')).hide();
            }

            renderAdjustmentHistory() {
                const history = JSON.parse(localStorage.getItem(`adjustment_history_${this.currentProject.id}`)) || [];
                const historyHtml = history.length > 0 ?
                    history.map(item => `
                        <div class="history-item">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">${item.timestamp}</small>
                                <small class="text-muted">${item.user}</small>
                            </div>
                            <div>${item.action}</div>
                        </div>
                    `).join('') :
                    '<div class="text-center text-muted">調整履歴はありません</div>';

                document.getElementById('adjustmentHistory').innerHTML = historyHtml;
            }

            addToHistory(action) {
                const history = JSON.parse(localStorage.getItem(`adjustment_history_${this.currentProject.id}`)) || [];
                history.unshift({
                    timestamp: new Date().toLocaleString('ja-JP'),
                    user: this.currentUser.name,
                    action: action
                });
                localStorage.setItem(`adjustment_history_${this.currentProject.id}`, JSON.stringify(history.slice(0, 20)));
                this.renderAdjustmentHistory();
            }

            saveAdjustments() {
                localStorage.setItem(`adjustments_${this.currentProject.id}`, JSON.stringify(this.adjustments));
                const comment = document.getElementById('adjustmentComment').value;
                localStorage.setItem(`adjustment_comment_${this.currentProject.id}`, comment);

                this.showNotification('調整内容を保存しました', 'success');
            }

            approveQuotation() {
                if (confirm('見積書を承認して送信準備を完了しますか？')) {
                    this.currentProject.status = 'approved';
                    this.currentProject.approvedBy = this.currentUser.name;
                    this.currentProject.approvedAt = new Date().toISOString();

                    localStorage.setItem(`project_${this.currentProject.id}`, JSON.stringify(this.currentProject));
                    this.addToHistory('見積書を承認・送信準備完了');

                    this.showNotification('見積書を承認しました。送信準備が完了しています。', 'success');

                    setTimeout(() => {
                        window.location.href = 'surveyed_projects_list.html';
                    }, 2000);
                }
            }

            requestRevision() {
                const reason = prompt('再調整の理由を入力してください:');
                if (reason) {
                    this.currentProject.status = 'auto_quote';
                    localStorage.setItem(`project_${this.currentProject.id}`, JSON.stringify(this.currentProject));
                    this.addToHistory(`再調整を依頼: ${reason}`);

                    this.showNotification('再調整依頼を送信しました', 'info');

                    setTimeout(() => {
                        window.location.href = 'auto_quotation.html?id=' + this.currentProject.id;
                    }, 1500);
                }
            }

            setupAutoSave() {
                setInterval(() => {
                    this.saveAdjustments();
                }, 30000);
            }

            setupRolePermissions() {
                if (this.currentUser.role !== '社員') {
                    document.querySelectorAll('.btn-approve, .btn-adjust').forEach(btn => {
                        btn.disabled = true;
                        btn.title = '社員権限が必要です';
                    });
                }
            }

            getConstructionTypeName(type) {
                const types = {
                    'kitchen': 'キッチン',
                    'bathroom': 'バスルーム',
                    'flooring': 'フローリング',
                    'wallpaper': 'クロス',
                    'electrical': '電気工事',
                    'plumbing': '配管工事',
                    'custom': 'カスタム'
                };
                return types[type] || type;
            }

            getCategoryName(category) {
                const categories = {
                    'material': '材料費',
                    'labor': '人件費',
                    'equipment': '設備費',
                    'other': 'その他'
                };
                return categories[category] || category;
            }

            showNotification(message, type = 'info') {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                alertDiv.style.top = '20px';
                alertDiv.style.right = '20px';
                alertDiv.style.zIndex = '9999';
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);

                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.parentNode.removeChild(alertDiv);
                    }
                }, 5000);
            }
        }

        const quotationAdjustment = new QuotationAdjustmentSystem();
    </script>
</body>
</html>