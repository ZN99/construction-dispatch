<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>材料費入力 - 建築派遣SaaS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../css/quotation_workflow.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif;
            padding-bottom: 100px;
        }
        .header-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .material-category {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        .material-item {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        .material-item:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .cost-input {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        .cost-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .calculation-summary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .submit-section {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        .role-badge {
            position: absolute;
            top: 10px;
            right: 15px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .employee-only {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid #28a745;
            color: #28a745;
        }
        .both-access {
            background: rgba(0, 123, 255, 0.1);
            border: 1px solid #007bff;
            color: #007bff;
        }
        .survey-reference {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="header-section">
        <div class="container">
            <div class="row align-items-center">
                <div class="col">
                    <h2><i class="bi bi-calculator"></i> 材料費入力</h2>
                    <p class="mb-0">現地調査データに基づく材料費算出</p>
                </div>
                <div class="col-auto">
                    <span class="badge bg-light text-dark fs-6" id="userRoleBadge"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Workflow Progress -->
        <div class="workflow-progress mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-white mb-0">見積作成進捗</h6>
                <span class="badge bg-light text-dark">ステップ 2/4</span>
            </div>
            <div class="progress" style="height: 8px;">
                <div class="progress-bar" role="progressbar" style="width: 50%"></div>
            </div>
            <div class="d-flex justify-content-between mt-2">
                <small class="text-white-50">現地調査</small>
                <small class="text-white">材料費入力</small>
                <small class="text-white-50">マージン設定</small>
                <small class="text-white-50">見積生成</small>
            </div>
        </div>

        <!-- Survey Reference -->
        <div class="survey-reference">
            <h6><i class="bi bi-clipboard-data text-primary"></i> 現地調査データ参照</h6>
            <div class="row" id="surveyData">
                <div class="col-md-3">
                    <strong>間取り:</strong>
                    <div id="propertyType">-</div>
                </div>
                <div class="col-md-3">
                    <strong>作業種別:</strong>
                    <div id="workType">-</div>
                </div>
                <div class="col-md-3">
                    <strong>床面積:</strong>
                    <div id="floorArea">-</div>
                </div>
                <div class="col-md-3">
                    <strong>壁面積:</strong>
                    <div id="wallArea">-</div>
                </div>
            </div>
        </div>

        <!-- Cleaning Materials -->
        <div class="material-category">
            <div class="position-relative">
                <h5><i class="bi bi-droplet"></i> クリーニング材料</h5>
                <span class="role-badge both-access">社員・派遣共通</span>
            </div>

            <div class="material-item">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <strong>多用途洗剤</strong>
                        <div class="text-muted small">居室・水回り用</div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="number" class="form-control cost-input" id="detergent_qty" placeholder="数量" min="0" step="0.1">
                            <span class="input-group-text">L</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" class="form-control cost-input" id="detergent_unit" placeholder="単価" min="0">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="fw-bold text-primary" id="detergent_total">¥0</div>
                    </div>
                </div>
            </div>

            <div class="material-item">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <strong>カビ取り剤</strong>
                        <div class="text-muted small">浴室・水回り専用</div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="number" class="form-control cost-input" id="mold_cleaner_qty" placeholder="数量" min="0" step="0.1">
                            <span class="input-group-text">本</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" class="form-control cost-input" id="mold_cleaner_unit" placeholder="単価" min="0">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="fw-bold text-primary" id="mold_cleaner_total">¥0</div>
                    </div>
                </div>
            </div>

            <div class="material-item">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <strong>清拭用品セット</strong>
                        <div class="text-muted small">雑巾・スポンジ等</div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="number" class="form-control cost-input" id="cleaning_tools_qty" placeholder="数量" min="0" step="1">
                            <span class="input-group-text">セット</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" class="form-control cost-input" id="cleaning_tools_unit" placeholder="単価" min="0">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="fw-bold text-primary" id="cleaning_tools_total">¥0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Wallpaper Materials -->
        <div class="material-category">
            <div class="position-relative">
                <h5><i class="bi bi-palette"></i> 壁紙関連材料</h5>
                <span class="role-badge both-access">社員・派遣共通</span>
            </div>

            <div class="material-item">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <strong>ビニールクロス</strong>
                        <div class="text-muted small">標準仕様（白色）</div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="number" class="form-control cost-input" id="wallpaper_qty" placeholder="数量" min="0" step="0.1">
                            <span class="input-group-text">㎡</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" class="form-control cost-input" id="wallpaper_unit" placeholder="単価" min="0">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="fw-bold text-primary" id="wallpaper_total">¥0</div>
                    </div>
                </div>
            </div>

            <div class="material-item">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <strong>壁紙用接着剤</strong>
                        <div class="text-muted small">施工用糊</div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="number" class="form-control cost-input" id="adhesive_qty" placeholder="数量" min="0" step="0.5">
                            <span class="input-group-text">kg</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" class="form-control cost-input" id="adhesive_unit" placeholder="単価" min="0">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="fw-bold text-primary" id="adhesive_total">¥0</div>
                    </div>
                </div>
            </div>

            <div class="material-item">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <strong>下地処理材</strong>
                        <div class="text-muted small">パテ・シーラー等</div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="number" class="form-control cost-input" id="primer_qty" placeholder="数量" min="0" step="0.1">
                            <span class="input-group-text">kg</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" class="form-control cost-input" id="primer_unit" placeholder="単価" min="0">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="fw-bold text-primary" id="primer_total">¥0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Plumbing Materials -->
        <div class="material-category">
            <div class="position-relative">
                <h5><i class="bi bi-wrench"></i> 水道設備材料</h5>
                <span class="role-badge employee-only">社員専用</span>
            </div>

            <div class="material-item" data-employee-only="true">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <strong>水栓金具</strong>
                        <div class="text-muted small">キッチン・洗面用</div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="number" class="form-control cost-input" id="faucet_qty" placeholder="数量" min="0" step="1">
                            <span class="input-group-text">個</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" class="form-control cost-input" id="faucet_unit" placeholder="単価" min="0">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="fw-bold text-primary" id="faucet_total">¥0</div>
                    </div>
                </div>
            </div>

            <div class="material-item" data-employee-only="true">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <strong>給排水管材</strong>
                        <div class="text-muted small">配管・継手類</div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="number" class="form-control cost-input" id="pipes_qty" placeholder="数量" min="0" step="0.5">
                            <span class="input-group-text">m</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" class="form-control cost-input" id="pipes_unit" placeholder="単価" min="0">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="fw-bold text-primary" id="pipes_total">¥0</div>
                    </div>
                </div>
            </div>

            <div class="material-item" data-employee-only="true">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <strong>防水・シール材</strong>
                        <div class="text-muted small">コーキング材等</div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="number" class="form-control cost-input" id="sealant_qty" placeholder="数量" min="0" step="1">
                            <span class="input-group-text">本</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" class="form-control cost-input" id="sealant_unit" placeholder="単価" min="0">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="fw-bold text-primary" id="sealant_total">¥0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cost Summary -->
        <div class="calculation-summary">
            <h5><i class="bi bi-calculator"></i> 材料費合計</h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="text-center">
                        <h3 id="cleaningTotal">¥0</h3>
                        <small>クリーニング材料</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <h3 id="wallpaperTotal">¥0</h3>
                        <small>壁紙関連材料</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <h3 id="plumbingTotal">¥0</h3>
                        <small>水道設備材料</small>
                    </div>
                </div>
            </div>
            <hr class="border-light">
            <div class="text-center">
                <h2 id="grandTotal">¥0</h2>
                <small>総材料費</small>
            </div>
        </div>
    </div>

    <!-- Submit Section -->
    <div class="submit-section">
        <div class="container">
            <div class="row">
                <div class="col">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="saveDraft()">
                        <i class="bi bi-save"></i> 下書き保存
                    </button>
                </div>
                <div class="col">
                    <button type="button" class="btn btn-primary w-100" id="submitCosts">
                        <i class="bi bi-send"></i> 材料費確定
                    </button>
                </div>
            </div>
            <div class="text-center mt-2">
                <small class="text-muted">確定後、マージン設定に進みます</small>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-check-circle"></i> 材料費確定完了</h5>
                </div>
                <div class="modal-body">
                    <p>材料費の入力が完了しました。</p>
                    <div class="alert alert-info">
                        <strong>総材料費:</strong> <span id="modalTotal">¥0</span>
                    </div>
                    <p>次のステップ「マージン設定」に進んでください。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="proceedToMargin()">マージン設定へ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/quotation_workflow.js"></script>
    <script>
        class MaterialCostInput {
            constructor() {
                this.workflow = new QuotationWorkflow();
                this.materials = [
                    'detergent', 'mold_cleaner', 'cleaning_tools',
                    'wallpaper', 'adhesive', 'primer',
                    'faucet', 'pipes', 'sealant'
                ];
                this.initializeApp();
            }

            initializeApp() {
                this.validateAccess();
                this.displayUserRole();
                this.loadSurveyData();
                this.setupEventListeners();
                this.loadSavedData();
                this.enforceRoleRestrictions();
            }

            validateAccess() {
                const userRole = this.workflow.getUserRole();
                if (!['employee', 'temporary'].includes(userRole)) {
                    alert('アクセス権限がありません。');
                    window.location.href = '../index_manager.html';
                    return;
                }
            }

            displayUserRole() {
                const userRole = this.workflow.getUserRole();
                const badge = document.getElementById('userRoleBadge');
                if (userRole === 'employee') {
                    badge.textContent = '社員';
                    badge.className = 'badge bg-success fs-6';
                } else {
                    badge.textContent = '派遣';
                    badge.className = 'badge bg-info fs-6';
                }
            }

            loadSurveyData() {
                const surveyData = this.workflow.getCurrentSurveyData();
                if (surveyData) {
                    document.getElementById('propertyType').textContent = surveyData.propertyType || '-';
                    document.getElementById('workType').textContent =
                        this.getWorkTypeLabel(surveyData.workType) || '-';
                    document.getElementById('floorArea').textContent =
                        surveyData.measurements ? `${surveyData.measurements.floorArea.toFixed(1)}㎡` : '-';
                    document.getElementById('wallArea').textContent =
                        surveyData.measurements ? `${surveyData.measurements.wallArea.toFixed(1)}㎡` : '-';

                    // Pre-fill suggested quantities based on survey data
                    this.suggestQuantities(surveyData);
                }
            }

            getWorkTypeLabel(workType) {
                const labels = {
                    'cleaning': 'クリーニング作業',
                    'wallpaper': '壁紙貼り替え',
                    'plumbing': '水道設備工事',
                    'combined': '複合作業'
                };
                return labels[workType] || workType;
            }

            suggestQuantities(surveyData) {
                if (!surveyData.measurements) return;

                const { floorArea, wallArea } = surveyData.measurements;

                // Cleaning materials based on floor area
                if (floorArea > 0) {
                    document.getElementById('detergent_qty').value = Math.max(1, (floorArea / 10).toFixed(1));
                    document.getElementById('cleaning_tools_qty').value = Math.max(1, Math.ceil(floorArea / 20));
                }

                // Wallpaper based on wall area
                if (wallArea > 0 && surveyData.workType === 'wallpaper') {
                    document.getElementById('wallpaper_qty').value = (wallArea * 1.1).toFixed(1); // 10% extra
                    document.getElementById('adhesive_qty').value = Math.max(1, (wallArea / 10).toFixed(1));
                    document.getElementById('primer_qty').value = Math.max(0.5, (wallArea / 15).toFixed(1));
                }
            }

            enforceRoleRestrictions() {
                const userRole = this.workflow.getUserRole();

                if (userRole === 'temporary') {
                    // Disable employee-only materials for dispatch staff
                    const employeeOnlyItems = document.querySelectorAll('[data-employee-only="true"]');
                    employeeOnlyItems.forEach(item => {
                        item.style.opacity = '0.5';
                        const inputs = item.querySelectorAll('input');
                        inputs.forEach(input => {
                            input.disabled = true;
                            input.placeholder = '社員専用';
                        });
                    });
                }
            }

            setupEventListeners() {
                // Setup calculation listeners for all materials
                this.materials.forEach(material => {
                    ['qty', 'unit'].forEach(type => {
                        const input = document.getElementById(`${material}_${type}`);
                        if (input) {
                            input.addEventListener('input', () => {
                                this.calculateItemTotal(material);
                                this.calculateCategoryTotals();
                                this.calculateGrandTotal();
                                this.autoSave();
                            });
                        }
                    });
                });

                // Submit button
                document.getElementById('submitCosts').addEventListener('click', () => {
                    this.submitCosts();
                });

                // Auto-save every 30 seconds
                setInterval(() => {
                    this.autoSave();
                }, 30000);
            }

            calculateItemTotal(material) {
                const qtyInput = document.getElementById(`${material}_qty`);
                const unitInput = document.getElementById(`${material}_unit`);
                const totalElement = document.getElementById(`${material}_total`);

                if (qtyInput && unitInput && totalElement) {
                    const qty = parseFloat(qtyInput.value) || 0;
                    const unit = parseFloat(unitInput.value) || 0;
                    const total = qty * unit;

                    totalElement.textContent = `¥${total.toLocaleString()}`;
                }
            }

            calculateCategoryTotals() {
                const cleaningMaterials = ['detergent', 'mold_cleaner', 'cleaning_tools'];
                const wallpaperMaterials = ['wallpaper', 'adhesive', 'primer'];
                const plumbingMaterials = ['faucet', 'pipes', 'sealant'];

                const cleaningTotal = this.calculateCategoryTotal(cleaningMaterials);
                const wallpaperTotal = this.calculateCategoryTotal(wallpaperMaterials);
                const plumbingTotal = this.calculateCategoryTotal(plumbingMaterials);

                document.getElementById('cleaningTotal').textContent = `¥${cleaningTotal.toLocaleString()}`;
                document.getElementById('wallpaperTotal').textContent = `¥${wallpaperTotal.toLocaleString()}`;
                document.getElementById('plumbingTotal').textContent = `¥${plumbingTotal.toLocaleString()}`;
            }

            calculateCategoryTotal(materials) {
                return materials.reduce((total, material) => {
                    const qtyInput = document.getElementById(`${material}_qty`);
                    const unitInput = document.getElementById(`${material}_unit`);

                    if (qtyInput && unitInput) {
                        const qty = parseFloat(qtyInput.value) || 0;
                        const unit = parseFloat(unitInput.value) || 0;
                        total += qty * unit;
                    }

                    return total;
                }, 0);
            }

            calculateGrandTotal() {
                const cleaningTotal = this.calculateCategoryTotal(['detergent', 'mold_cleaner', 'cleaning_tools']);
                const wallpaperTotal = this.calculateCategoryTotal(['wallpaper', 'adhesive', 'primer']);
                const plumbingTotal = this.calculateCategoryTotal(['faucet', 'pipes', 'sealant']);

                const grandTotal = cleaningTotal + wallpaperTotal + plumbingTotal;
                document.getElementById('grandTotal').textContent = `¥${grandTotal.toLocaleString()}`;
            }

            collectMaterialData() {
                const data = {
                    materials: {},
                    categories: {},
                    totalCost: 0,
                    timestamp: new Date().toISOString(),
                    userRole: this.workflow.getUserRole()
                };

                this.materials.forEach(material => {
                    const qtyInput = document.getElementById(`${material}_qty`);
                    const unitInput = document.getElementById(`${material}_unit`);

                    if (qtyInput && unitInput) {
                        const qty = parseFloat(qtyInput.value) || 0;
                        const unit = parseFloat(unitInput.value) || 0;
                        const total = qty * unit;

                        data.materials[material] = {
                            quantity: qty,
                            unitCost: unit,
                            totalCost: total
                        };
                    }
                });

                // Calculate category totals
                data.categories.cleaning = this.calculateCategoryTotal(['detergent', 'mold_cleaner', 'cleaning_tools']);
                data.categories.wallpaper = this.calculateCategoryTotal(['wallpaper', 'adhesive', 'primer']);
                data.categories.plumbing = this.calculateCategoryTotal(['faucet', 'pipes', 'sealant']);
                data.totalCost = data.categories.cleaning + data.categories.wallpaper + data.categories.plumbing;

                return data;
            }

            autoSave() {
                const data = this.collectMaterialData();
                localStorage.setItem('materialCostDraft', JSON.stringify(data));
            }

            loadSavedData() {
                const saved = localStorage.getItem('materialCostDraft');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        Object.keys(data.materials).forEach(material => {
                            const materialData = data.materials[material];
                            const qtyInput = document.getElementById(`${material}_qty`);
                            const unitInput = document.getElementById(`${material}_unit`);

                            if (qtyInput && unitInput) {
                                qtyInput.value = materialData.quantity || '';
                                unitInput.value = materialData.unitCost || '';
                                this.calculateItemTotal(material);
                            }
                        });
                        this.calculateCategoryTotals();
                        this.calculateGrandTotal();
                    } catch (e) {
                        console.error('Failed to load saved data:', e);
                    }
                }
            }

            async submitCosts() {
                const materialData = this.collectMaterialData();

                if (materialData.totalCost === 0) {
                    alert('材料費を入力してください。');
                    return;
                }

                try {
                    // Submit to workflow system
                    await this.workflow.submitMaterialCosts(materialData);

                    // Log activity
                    this.workflow.logActivity('material_costs_submitted', {
                        totalCost: materialData.totalCost,
                        categories: materialData.categories
                    });

                    // Clear draft
                    localStorage.removeItem('materialCostDraft');

                    // Show success modal
                    document.getElementById('modalTotal').textContent = `¥${materialData.totalCost.toLocaleString()}`;
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    successModal.show();

                } catch (error) {
                    alert('送信に失敗しました。再度お試しください。');
                    console.error('Material cost submission failed:', error);
                }
            }
        }

        // Global functions
        function saveDraft() {
            app.autoSave();
            alert('下書きを保存しました。');
        }

        function proceedToMargin() {
            const userRole = app.workflow.getUserRole();
            if (userRole === 'employee') {
                window.location.href = 'margin_setting.html';
            } else {
                window.location.href = 'staff_status_view.html';
            }
        }

        // Initialize app
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new MaterialCostInput();
        });
    </script>
</body>
</html>