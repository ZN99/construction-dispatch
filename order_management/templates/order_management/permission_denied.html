<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アクセス権限が必要です - 建築派遣管理システム</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        .permission-container {
            max-width: 600px;
            width: 100%;
            padding: 20px;
        }

        .permission-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            text-align: center;
        }

        .permission-header {
            margin-bottom: 30px;
        }

        .permission-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .icon-headquarters {
            color: #343a40;
        }

        .icon-admin {
            color: #dc3545;
        }

        .icon-field {
            color: #28a745;
        }

        .permission-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #343a40;
        }

        .permission-description {
            color: #6c757d;
            margin-bottom: 30px;
        }

        .current-user-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
        }

        .required-permission {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .account-examples {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
        }

        .btn-login {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-login:hover {
            background: linear-gradient(135deg, #23272b 0%, #343a40 100%);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
            text-decoration: none;
        }

        .btn-field {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-field:hover {
            background: linear-gradient(135deg, #1e7e34 0%, #17a2b8 100%);
            color: white;
        }

        .system-comparison {
            margin-top: 30px;
            text-align: left;
        }

        .system-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .system-headquarters {
            background: rgba(52, 58, 64, 0.1);
        }

        .system-field {
            background: rgba(40, 167, 69, 0.1);
        }

        .system-admin {
            background: rgba(220, 53, 69, 0.1);
        }
    </style>
</head>
<body>
    <div class="permission-container">
        <div class="permission-card">
            <!-- ヘッダー -->
            <div class="permission-header">
                {% if page_type == 'headquarters' %}
                    <i class="fas fa-building permission-icon icon-headquarters"></i>
                {% elif page_type == 'admin' %}
                    <i class="fas fa-cogs permission-icon icon-admin"></i>
                {% elif page_type == 'field' %}
                    <i class="fas fa-search permission-icon icon-field"></i>
                {% else %}
                    <i class="fas fa-lock permission-icon"></i>
                {% endif %}

                <h1 class="permission-title">アクセス権限が必要です</h1>
                <p class="permission-description">
                    {{ page_description }}にアクセスするには適切なアカウントでログインしてください。
                </p>
            </div>

            <!-- 現在のユーザー情報 -->
            {% if user.is_authenticated %}
            <div class="current-user-info">
                <h6><i class="fas fa-user me-2"></i>現在のログインユーザー</h6>
                <p class="mb-1"><strong>{{ user.username }}</strong> ({{ user.first_name }} {{ user.last_name }})</p>
                {% if is_field_surveyor %}
                    <small class="text-success">
                        <i class="fas fa-search me-1"></i>現場調査員アカウント
                    </small>
                {% elif user.is_staff %}
                    <small class="text-primary">
                        <i class="fas fa-building me-1"></i>本部スタッフアカウント
                    </small>
                {% elif user.is_superuser %}
                    <small class="text-danger">
                        <i class="fas fa-cogs me-1"></i>システム管理者アカウント
                    </small>
                {% else %}
                    <small class="text-muted">
                        <i class="fas fa-question-circle me-1"></i>権限不明
                    </small>
                {% endif %}
            </div>
            {% endif %}

            <!-- 必要な権限 -->
            <div class="required-permission">
                <h6><i class="fas fa-key me-2"></i>このページに必要な権限</h6>
                <p class="mb-1"><strong>{{ required_account }}</strong></p>
                {% if example_accounts %}
                    <small class="text-muted">
                        例:
                        {% for account in example_accounts %}
                            {{ account.username }} ({{ account.description }}){% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    </small>
                {% endif %}
            </div>

            <!-- アクション -->
            <div class="text-center">
                {% if user.is_authenticated %}
                    <!-- 既にログイン済みの場合 -->
                    {% if is_field_surveyor %}
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle me-2"></i>
                            現場調査員アカウントでログイン中です。本部システムにはアクセスできません。
                        </div>

                        <p class="mb-3">現場調査員システムをご利用ください：</p>
                        <a href="{% url 'surveys:field_dashboard' %}" class="btn btn-field mb-2">
                            <i class="fas fa-search me-2"></i>現場調査員システム
                        </a>

                        <div class="mt-3">
                            <p class="mb-3">または、本部スタッフアカウントでログインし直してください：</p>
                            <a href="{% url 'surveys:field_logout' %}" class="btn btn-outline-danger me-2" id="logoutAndSwitchBtn">
                                <i class="fas fa-sign-out-alt me-2"></i>ログアウトして本部システムへ
                            </a>
                        </div>

                        <div class="mt-3">
                            <small class="text-muted">
                                本部システムアクセス権限が必要な場合は、管理者にお問い合わせください。
                            </small>
                        </div>
                    {% else %}
                        <!-- 本部スタッフまたは権限不明の場合 -->
                        <div class="alert alert-warning mb-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {% if user.is_staff %}
                                本部スタッフアカウントでログイン中ですが、このページにはアクセスできません。
                            {% else %}
                                現在のアカウントでは、このページにアクセスできません。
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">適切なアカウントでログイン</h6>
                                        <p class="card-text small">{{ required_account }}が必要です</p>
                                        <a href="{% url 'order_management:logout' %}?next={{ login_url }}" class="btn btn-login btn-sm" id="logoutAndLoginBtn">
                                            <i class="fas fa-exchange-alt me-2"></i>ログアウト＆ログイン
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">システム選択に戻る</h6>
                                        <p class="card-text small">別のシステムを選択</p>
                                        <a href="{% url 'order_management:landing' %}" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-home me-2"></i>システム選択
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <a href="{{ login_url }}" class="btn btn-login">
                                <i class="fas fa-sign-in-alt me-2"></i>{{ required_account }}で直接ログイン
                            </a>
                        </div>
                    {% endif %}
                {% else %}
                    <!-- 未ログインの場合 -->
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        このページにアクセスするには、{{ required_account }}でのログインが必要です。
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <h6 class="card-title">{{ required_account }}でログイン</h6>
                                    <p class="card-text small">このページに必要な権限</p>
                                    <a href="{{ login_url }}" class="btn btn-login btn-sm">
                                        <i class="fas fa-sign-in-alt me-2"></i>ログイン
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <h6 class="card-title">システム選択</h6>
                                    <p class="card-text small">他のシステムを選択</p>
                                    <a href="{% url 'order_management:landing' %}" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-home me-2"></i>選択画面
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- システム比較 -->
            <div class="system-comparison">
                <h6><i class="fas fa-info-circle me-2"></i>システム別アクセス権限</h6>

                <div class="system-item system-headquarters">
                    <div class="me-3">
                        <i class="fas fa-building fa-2x text-dark"></i>
                    </div>
                    <div>
                        <strong>本部システム</strong><br>
                        <small>案件管理・発注管理・調査管理 | 本部スタッフ専用</small>
                    </div>
                </div>

                <div class="system-item system-field">
                    <div class="me-3">
                        <i class="fas fa-search fa-2x text-success"></i>
                    </div>
                    <div>
                        <strong>現場調査員システム</strong><br>
                        <small>自分の調査案件のみ | 現場調査員専用</small>
                    </div>
                </div>

                <div class="system-item system-admin">
                    <div class="me-3">
                        <i class="fas fa-cogs fa-2x text-danger"></i>
                    </div>
                    <div>
                        <strong>管理画面</strong><br>
                        <small>システム全体の管理 | システム管理者専用</small>
                    </div>
                </div>
            </div>

            <!-- フッター -->
            <div class="mt-4 pt-3 border-top">
                <small class="text-muted">
                    <i class="fas fa-question-circle me-1"></i>
                    アカウントに関するお問い合わせは、システム管理者までご連絡ください。
                </small>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // ログアウト後に適切なログイン画面にリダイレクト
    document.addEventListener('DOMContentLoaded', function() {
        // URLパラメータから必要な情報を取得
        const urlParams = new URLSearchParams(window.location.search);
        const nextPage = urlParams.get('next');

        // 「ログアウトして本部システムへ」ボタンの処理
        const logoutAndSwitchBtn = document.getElementById('logoutAndSwitchBtn');
        if (logoutAndSwitchBtn) {
            logoutAndSwitchBtn.addEventListener('click', function(e) {
                e.preventDefault();

                // ログアウト後に本部システムのログイン画面へ
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ログアウト中...';
                this.disabled = true;

                setTimeout(() => {
                    window.location.href = '{% url "surveys:field_logout" %}';
                }, 500);
            });
        }

        // 「ログアウト＆ログイン」ボタンの処理
        const logoutAndLoginBtn = document.getElementById('logoutAndLoginBtn');
        if (logoutAndLoginBtn) {
            logoutAndLoginBtn.addEventListener('click', function(e) {
                e.preventDefault();

                // ローディング状態にする
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>切り替え中...';
                this.disabled = true;

                // ログアウト後に該当するログイン画面へ
                setTimeout(() => {
                    window.location.href = '{% url "order_management:logout" %}';
                }, 500);
            });
        }

        // アクセス試行中ページの記憶
        if (nextPage) {
            sessionStorage.setItem('attempted_page', nextPage);
            console.log('Attempted page stored:', nextPage);
        }
    });

    // ボタンクリック時のビジュアルフィードバック
    document.querySelectorAll('.btn:not(#logoutAndSwitchBtn):not(#logoutAndLoginBtn)').forEach(btn => {
        btn.addEventListener('click', function() {
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 100);
        });
    });
    </script>
</body>
</html>