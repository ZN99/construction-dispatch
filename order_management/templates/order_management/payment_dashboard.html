{% extends 'order_management/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}出金管理 - {{ month_name }} {{ year }}{% endblock %}

{% block extra_css %}
<style>
    .payment-dashboard {
        background: #f8f9fa;
        min-height: 100vh;
        padding: 0;
        margin: 0;
    }

    .header-section {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 1.5rem 0;
        margin-bottom: 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 100%;
    }

    .header-title h1 {
        font-size: 2rem;
        font-weight: 300;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header-title p {
        font-size: 1rem;
        opacity: 0.9;
        margin: 0.3rem 0 0 0;
    }

    .header-amount {
        text-align: right;
    }

    .total-amount {
        font-size: 2.2rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .amount-label {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .controls-section {
        background: #f8f9fa;
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: center;
    }

    .compact-filters {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .compact-filters select {
        border: 1px solid #ced4da;
        border-radius: 6px;
        padding: 0.3rem 0.5rem;
        font-size: 0.85rem;
        background: white;
        min-width: 80px;
        cursor: pointer;
    }

    .compact-filters select:focus {
        border-color: #0d6efd;
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.25);
    }

    .more-filters {
        margin-left: 0.5rem;
    }

    .more-filters summary {
        cursor: pointer;
        font-size: 0.8rem;
        color: #6c757d;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 6px;
        padding: 0.3rem 0.6rem;
        list-style: none;
    }

    .more-filters summary:hover {
        background: #f8f9fa;
        color: #495057;
    }

    .extra-filters {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 6px;
        position: absolute;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }


    .stats-section {
        background: white;
        padding: 1.5rem 0;
        border-bottom: 1px solid #e9ecef;
    }

    .stat-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 1.2rem;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    .stat-value {
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 0.3rem;
        font-family: 'SF Mono', 'Monaco', monospace;
    }

    .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: 500;
    }

    .stat-scheduled .stat-value { color: #ffc107; }
    .stat-executed .stat-value { color: #28a745; }
    .stat-overdue .stat-value { color: #dc3545; }
    .stat-total .stat-value { color: #007bff; }

    .content-section {
        background: white;
        margin: 0;
        padding: 1.5rem 0;
    }

    .payment-table-wrapper {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        margin: 0;
    }

    .table {
        margin: 0;
        font-size: 0.85rem;
        width: 100%;
    }

    .table th {
        background: #495057;
        color: white;
        font-weight: 600;
        padding: 0.8rem 0.5rem;
        border: none;
        position: sticky;
        top: 0;
        z-index: 10;
        font-size: 0.8rem;
        white-space: nowrap;
    }

    .table td {
        padding: 0.7rem 0.5rem;
        vertical-align: middle;
        border-bottom: 1px solid #f8f9fa;
        font-size: 0.85rem;
    }

    .contractor-header {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
        font-weight: 600;
    }

    .contractor-header td {
        padding: 0.8rem 0.5rem;
        border: none;
    }

    .contractor-name {
        font-size: 1rem;
        font-weight: 700;
    }

    .contractor-stats {
        font-size: 0.8rem;
        opacity: 0.9;
    }

    .project-row {
        transition: background-color 0.2s ease;
    }

    .project-row:hover {
        background-color: #f8f9fa;
    }

    .project-link {
        color: #007bff;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s ease;
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 200px;
    }

    .project-link:hover {
        color: #0056b3;
        text-decoration: underline;
    }

    .amount-cell {
        text-align: right;
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace;
        font-weight: 600;
        font-size: 0.85rem;
        white-space: nowrap;
    }

    .date-cell {
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Droid Sans Mono', 'Source Code Pro', monospace;
        color: #6c757d;
        font-size: 0.8rem;
        white-space: nowrap;
    }

    .status-badge {
        padding: 0.3rem 0.6rem;
        border-radius: 15px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        white-space: nowrap;
    }

    .status-scheduled {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }

    .status-executed {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-overdue {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .status-cancelled {
        background: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
    }

    .contractor-summary {
        background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
        border-top: 2px solid #007bff;
        font-weight: 600;
    }

    .contractor-summary td {
        padding: 0.7rem 0.5rem;
    }

    .summary-amounts {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        align-items: center;
        flex-wrap: wrap;
    }

    .summary-amount {
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .summary-executed {
        background: #d4edda;
        color: #155724;
    }

    .summary-scheduled {
        background: #fff3cd;
        color: #856404;
    }

    .summary-overdue {
        background: #f8d7da;
        color: #721c24;
    }

    .table-footer {
        background: linear-gradient(135deg, #343a40 0%, #495057 100%);
        color: white;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .table-footer td {
        padding: 1rem 0.5rem;
        border: none;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    .btn-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }

    .outflow-badge {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .contractor-row:hover {
        background-color: #f8f9fa !important;
        transform: scale(1.01);
        transition: all 0.2s ease;
    }

    /* 詳細リストセクション */
    .detailed-lists-section {
        background: #f8f9fa;
        padding: 2rem 0;
        border-bottom: 1px solid #e9ecef;
    }

    .list-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
        margin-bottom: 1.5rem;
        height: 100%;
    }

    .list-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e9ecef;
        border-radius: 10px 10px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .list-header h4 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
    }

    .list-body {
        padding: 0;
        max-height: 400px;
        overflow-y: auto;
    }

    .list-card .table {
        margin: 0;
        border-radius: 0;
    }

    .list-card .table th {
        background: #f8f9fa;
        font-weight: 600;
        font-size: 0.8rem;
        color: #495057;
        border-top: none;
        padding: 0.75rem 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }

    .list-card .table td {
        padding: 0.6rem 0.5rem;
        font-size: 0.85rem;
        border-color: #f1f3f4;
    }

    .list-card .empty-state {
        padding: 2rem 1rem;
        text-align: center;
        color: #6c757d;
    }

    .list-card .empty-state i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        opacity: 0.5;
    }

    /* レスポンシブ対応 */
    @media (max-width: 1200px) {
        .table {
            font-size: 0.8rem;
        }
        .table th, .table td {
            padding: 0.5rem 0.3rem;
        }
        .project-link {
            max-width: 150px;
        }
    }

    @media (max-width: 992px) {
        .header-content {
            flex-direction: column;
            text-align: center;
            gap: 1rem;
        }

        .filter-controls {
            justify-content: center;
        }

        .table {
            font-size: 0.75rem;
        }

        .table th, .table td {
            padding: 0.4rem 0.2rem;
        }

        .project-link {
            max-width: 120px;
        }

        .summary-amounts {
            flex-direction: column;
            gap: 0.3rem;
        }
    }

    @media (max-width: 768px) {
        .stat-card {
            margin-bottom: 0.5rem;
            height: 80px;
            padding: 0.8rem;
        }

        .stat-value {
            font-size: 1.2rem;
        }

        .table {
            font-size: 0.7rem;
        }

        .contractor-stats {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="payment-dashboard">
    <!-- ヘッダーセクション -->
    <div class="header-section">
        <div class="container-fluid">
            <div class="header-content">
                <div class="header-title">
                    <h1><i class="fas fa-money-bill-wave"></i> 出金管理</h1>
                    <p>{{ year }}年{{ month }}月 - 今月の出金ベース集計 <span class="outflow-badge">出金ベース</span></p>
                </div>
                <div class="header-amount">
                    <div class="total-amount">¥{{ stats.total_outflow|intcomma }}</div>
                    <div class="amount-label">今月の総出金予定額</div>
                </div>
            </div>
        </div>
    </div>

    <!-- コントロールセクション -->
    <div class="controls-section">
        <form method="get" class="compact-filters">
            <select name="year" onchange="this.form.submit()">
                <option value="2024" {% if year == 2024 %}selected{% endif %}>2024年</option>
                <option value="2025" {% if year == 2025 %}selected{% endif %}>2025年</option>
                <option value="2026" {% if year == 2026 %}selected{% endif %}>2026年</option>
            </select>
            <select name="month" onchange="this.form.submit()">
                <option value="1" {% if month == 1 %}selected{% endif %}>1月</option>
                <option value="2" {% if month == 2 %}selected{% endif %}>2月</option>
                <option value="3" {% if month == 3 %}selected{% endif %}>3月</option>
                <option value="4" {% if month == 4 %}selected{% endif %}>4月</option>
                <option value="5" {% if month == 5 %}selected{% endif %}>5月</option>
                <option value="6" {% if month == 6 %}selected{% endif %}>6月</option>
                <option value="7" {% if month == 7 %}selected{% endif %}>7月</option>
                <option value="8" {% if month == 8 %}selected{% endif %}>8月</option>
                <option value="9" {% if month == 9 %}selected{% endif %}>9月</option>
                <option value="10" {% if month == 10 %}selected{% endif %}>10月</option>
                <option value="11" {% if month == 11 %}selected{% endif %}>11月</option>
                <option value="12" {% if month == 12 %}selected{% endif %}>12月</option>
            </select>
            <select name="status" onchange="this.form.submit()">
                {% for value, label in payment_status_choices %}
                    <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            <details class="more-filters">
                <summary>詳細</summary>
                <div class="extra-filters">
                    <select name="contractor" onchange="this.form.submit()">
                        {% for value, label in contractor_choices %}
                            <option value="{{ value }}" {% if contractor_filter == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <select name="worker_type" onchange="this.form.submit()">
                        {% for value, label in worker_type_choices %}
                            <option value="{{ value }}" {% if worker_type_filter == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </details>
        </form>
    </div>

    <!-- 統計セクション -->
    <div class="stats-section">
        <div class="container-fluid">
            <div class="row g-3">
                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-value">{{ stats.total_payees }}</div>
                        <div class="stat-label">出金先数</div>
                    </div>
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                    <div class="stat-card">
                        <div class="stat-value">{{ stats.total_subcontracts }}</div>
                        <div class="stat-label">外注件数</div>
                    </div>
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                    <div class="stat-card stat-executed">
                        <div class="stat-value">¥{{ stats.executed_amount|intcomma }}</div>
                        <div class="stat-label">出金済み総額</div>
                    </div>
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                    <div class="stat-card stat-scheduled">
                        <div class="stat-value">¥{{ stats.scheduled_amount|intcomma }}</div>
                        <div class="stat-label">出金予定額（未払い）</div>
                    </div>
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                    <div class="stat-card stat-total">
                        <div class="stat-value">¥{{ stats.total_outflow|intcomma }}</div>
                        <div class="stat-label">単月出金予定総額</div>
                    </div>
                </div>
                <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
                    <div class="stat-card stat-overdue">
                        <div class="stat-value">¥{{ stats.overdue_amount|intcomma }}</div>
                        <div class="stat-label">遅延</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 詳細リストセクション -->
    <div class="detailed-lists-section">
        <div class="container-fluid">
            <div class="row g-4">
                <!-- 今月振り込み済み現場リスト -->
                <div class="col-lg-6">
                    <div class="list-card">
                        <div class="list-header">
                            <h4><i class="fas fa-check-circle text-success"></i> 今月振り込み済み現場リスト</h4>
                            <span class="badge bg-success">{{ stats.paid_sites_count }}件</span>
                        </div>
                        <div class="list-body">
                            {% if paid_sites %}
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>現場名</th>
                                                <th>支払先</th>
                                                <th>金額</th>
                                                <th>支払日</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for site in paid_sites %}
                                                <tr>
                                                    <td>
                                                        <a href="{% url 'order_management:project_detail' site.project.pk %}" class="project-link">
                                                            {{ site.site_name }}
                                                        </a>
                                                    </td>
                                                    <td>{{ site.payee_name }}</td>
                                                    <td class="amount-cell">¥{{ site.amount|intcomma }}</td>
                                                    <td class="date-cell">{{ site.payment_date|date:"m/d" }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="empty-state">
                                    <i class="fas fa-info-circle"></i>
                                    <p>今月振り込み済みの現場はありません</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 業者別今月振り込み済み金額リスト -->
                <div class="col-lg-6">
                    <div class="list-card">
                        <div class="list-header">
                            <h4><i class="fas fa-users text-success"></i> 業者別今月振り込み済み金額</h4>
                            <span class="badge bg-success">{{ paid_contractors|length }}社</span>
                        </div>
                        <div class="list-body">
                            {% if paid_contractors %}
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>業者名</th>
                                                <th>種別</th>
                                                <th>現場数</th>
                                                <th>合計金額</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for contractor in paid_contractors %}
                                                <tr>
                                                    <td>{{ contractor.name }}</td>
                                                    <td>
                                                        <span class="badge {% if contractor.payee_type == '外注業者' %}bg-primary{% else %}bg-secondary{% endif %}">
                                                            {{ contractor.payee_type }}
                                                        </span>
                                                    </td>
                                                    <td>{{ contractor.sites_count }}件</td>
                                                    <td class="amount-cell">¥{{ contractor.total_amount|intcomma }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="empty-state">
                                    <i class="fas fa-info-circle"></i>
                                    <p>今月振り込み済みの業者はありません</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 今月振り込み予定現場リスト -->
                <div class="col-lg-6">
                    <div class="list-card">
                        <div class="list-header">
                            <h4><i class="fas fa-clock text-warning"></i> 今月振り込み予定現場リスト</h4>
                            <span class="badge bg-warning">{{ stats.pending_sites_count }}件</span>
                        </div>
                        <div class="list-body">
                            {% if pending_sites %}
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>現場名</th>
                                                <th>支払先</th>
                                                <th>金額</th>
                                                <th>予定日</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for site in pending_sites %}
                                                <tr>
                                                    <td>
                                                        <a href="{% url 'order_management:project_detail' site.project.pk %}" class="project-link">
                                                            {{ site.site_name }}
                                                        </a>
                                                    </td>
                                                    <td>{{ site.payee_name }}</td>
                                                    <td class="amount-cell">¥{{ site.amount|intcomma }}</td>
                                                    <td class="date-cell">{{ site.payment_date|date:"m/d" }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="empty-state">
                                    <i class="fas fa-info-circle"></i>
                                    <p>今月振り込み予定の現場はありません</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 業者別今月振り込み予定金額リスト -->
                <div class="col-lg-6">
                    <div class="list-card">
                        <div class="list-header">
                            <h4><i class="fas fa-users text-warning"></i> 業者別今月振り込み予定金額</h4>
                            <span class="badge bg-warning">{{ pending_contractors|length }}社</span>
                        </div>
                        <div class="list-body">
                            {% if pending_contractors %}
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th style="width: 20%;">業者名</th>
                                                <th style="width: 10%;">種別</th>
                                                <th style="width: 10%;">現場数</th>
                                                <th style="width: 15%;">合計金額</th>
                                                <th style="width: 25%;">銀行口座</th>
                                                <th style="width: 20%;">次回支払日</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for contractor in pending_contractors %}
                                                <tr class="contractor-row" style="cursor: pointer;"
                                                    data-contractor-name="{{ contractor.name }}"
                                                    data-payee-type="{{ contractor.payee_type }}"
                                                    data-sites-count="{{ contractor.sites_count }}"
                                                    data-total-amount="{{ contractor.total_amount }}"
                                                    data-bank-name="{% if contractor.bank_info %}{{ contractor.bank_info.bank_name }}{% endif %}"
                                                    data-account-number="{% if contractor.bank_info %}{{ contractor.bank_info.account_number }}{% endif %}"
                                                    data-account-holder="{% if contractor.bank_info %}{{ contractor.bank_info.account_holder }}{% endif %}"
                                                    data-payment-cycle="{% if contractor.bank_info %}{{ contractor.bank_info.payment_cycle }}{% endif %}"
                                                    data-payment-day="{% if contractor.bank_info %}{{ contractor.bank_info.payment_day }}{% endif %}"
                                                    data-auto-payment-date="{% if contractor.auto_payment_date %}{{ contractor.auto_payment_date|date:'Y-m-d' }}{% endif %}"
                                                    onclick="showContractorDetails(this)">
                                                    <td>{{ contractor.name }}</td>
                                                    <td>
                                                        <span class="badge {% if contractor.payee_type == '外注業者' %}bg-primary{% else %}bg-secondary{% endif %}">
                                                            {{ contractor.payee_type }}
                                                        </span>
                                                    </td>
                                                    <td>{{ contractor.sites_count }}件</td>
                                                    <td class="amount-cell">¥{{ contractor.total_amount|intcomma }}</td>
                                                    <td>
                                                        {% if contractor.bank_info %}
                                                            <small class="text-muted">
                                                                {{ contractor.bank_info.bank_name }}<br>
                                                                {{ contractor.bank_info.account_number }}
                                                            </small>
                                                        {% else %}
                                                            <span class="badge bg-danger">未設定</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="date-cell">
                                                        {% if contractor.auto_payment_date %}
                                                            {{ contractor.auto_payment_date|date:"m/d" }}
                                                            <small class="text-muted d-block">
                                                                {% if contractor.bank_info.payment_cycle == 'monthly' %}月払い
                                                                {% elif contractor.bank_info.payment_cycle == 'bimonthly' %}隔月払い
                                                                {% elif contractor.bank_info.payment_cycle == 'quarterly' %}四半期払い
                                                                {% else %}その他
                                                                {% endif %}
                                                            </small>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="empty-state">
                                    <i class="fas fa-info-circle"></i>
                                    <p>今月振り込み予定の業者はありません</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- コンテンツセクション -->
    <div class="content-section">
        <div class="container-fluid">
            {% if payee_summary %}
            <div class="payment-table-wrapper">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th style="width: 15%">出金先</th>
                                <th style="width: 20%">案件名</th>
                                <th style="width: 10%">作業期間</th>
                                <th style="width: 10%">契約額</th>
                                <th style="width: 10%">請求額</th>
                                <th style="width: 10%">支払予定日</th>
                                <th style="width: 10%">支払実行日</th>
                                <th style="width: 8%">支払状況</th>
                                <th style="width: 7%">種別</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payee_key, data in payee_summary.items %}
                                <!-- 出金先ヘッダー -->
                                <tr class="contractor-header">
                                    <td colspan="9">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="contractor-name">
                                                {% if data.payee_type == '外注業者' %}
                                                    <i class="fas fa-building"></i>
                                                {% else %}
                                                    <i class="fas fa-user-tie"></i>
                                                {% endif %}
                                                {{ data.payee_name }}
                                                <span class="badge bg-secondary ms-2">{{ data.payee_type }}</span>
                                            </div>
                                            <div class="contractor-stats">
                                                <span><i class="fas fa-tasks"></i> {{ data.project_count }}件</span>
                                                <span class="ms-3"><i class="fas fa-yen-sign"></i> ¥{{ data.total_amount|intcomma }}</span>
                                            </div>
                                        </div>
                                    </td>
                                </tr>

                                <!-- 外注詳細 -->
                                {% for subcontract in data.subcontracts %}
                                <tr class="project-row">
                                    <td></td>
                                    <td>
                                        <a href="{% url 'order_management:project_detail' subcontract.project.pk %}" class="project-link" title="{{ subcontract.site_name }}">
                                            <i class="fas fa-external-link-alt me-1"></i>{{ subcontract.site_name }}
                                        </a>
                                    </td>
                                    <td class="date-cell">
                                        {% if subcontract.work_start_date %}{{ subcontract.work_start_date|date:"m/d" }}{% else %}-{% endif %}
                                        {% if subcontract.work_end_date %}<br>{{ subcontract.work_end_date|date:"m/d" }}{% endif %}
                                    </td>
                                    <td class="amount-cell">
                                        {% if subcontract.contract_amount %}¥{{ subcontract.contract_amount|intcomma }}{% else %}-{% endif %}
                                    </td>
                                    <td class="amount-cell">
                                        {% if subcontract.billed_amount %}¥{{ subcontract.billed_amount|intcomma }}{% else %}-{% endif %}
                                    </td>
                                    <td class="date-cell">
                                        {% if subcontract.payment_date %}{{ subcontract.payment_date|date:"m/d" }}{% else %}<span class="text-muted">未設定</span>{% endif %}
                                    </td>
                                    <td class="date-cell">
                                        {% if subcontract.payment_status == 'paid' and subcontract.payment_date %}{{ subcontract.payment_date|date:"m/d" }}{% else %}<span class="text-muted">-</span>{% endif %}
                                    </td>
                                    <td>
                                        <span class="status-badge status-{{ subcontract.payment_status }}">
                                            {% if subcontract.payment_status == 'pending' %}未払い
                                            {% elif subcontract.payment_status == 'processing' %}処理中
                                            {% elif subcontract.payment_status == 'paid' %}支払済み
                                            {% else %}{{ subcontract.payment_status }}
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        {% if subcontract.worker_type == 'external' %}
                                            <span class="badge bg-primary">外注</span>
                                        {% else %}
                                            <span class="badge bg-success">社内</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}

                                <!-- 出金先合計 -->
                                <tr class="contractor-summary">
                                    <td><strong><i class="fas fa-calculator"></i> {{ data.payee_name }} 合計</strong></td>
                                    <td colspan="2"><strong>{{ data.project_count }}件</strong></td>
                                    <td class="amount-cell"><strong>-</strong></td>
                                    <td class="amount-cell"><strong>¥{{ data.total_amount|intcomma }}</strong></td>
                                    <td colspan="4">
                                        <div class="summary-amounts">
                                            {% if data.paid_amount > 0 %}
                                            <span class="summary-amount summary-executed">
                                                <i class="fas fa-check-circle"></i> ¥{{ data.paid_amount|intcomma }}
                                            </span>
                                            {% endif %}
                                            {% if data.pending_amount > 0 %}
                                            <span class="summary-amount summary-scheduled">
                                                <i class="fas fa-clock"></i> ¥{{ data.pending_amount|intcomma }}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>

                        <tfoot class="table-footer">
                            <tr>
                                <th colspan="4">
                                    <i class="fas fa-chart-line"></i> 総合計 - {{ year }}年{{ month }}月（出金ベース）
                                </th>
                                <th class="amount-cell">¥{{ stats.total_outflow|intcomma }}</th>
                                <th colspan="4">
                                    支払済み: ¥{{ stats.executed_amount|intcomma }} | 予定: ¥{{ stats.scheduled_amount|intcomma }} | 遅延: ¥{{ stats.overdue_amount|intcomma }}
                                </th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3>支払い対象案件なし</h3>
                <p class="text-muted">{{ year }}年{{ month }}月の支払い対象案件はありません。</p>
                {% if status_filter != 'all' %}
                <p class="text-info">フィルター条件:
                    {% for value, label in payment_status_choices %}
                        {% if value == status_filter %}{{ label }}{% endif %}
                    {% endfor %}
                </p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 業者詳細モーダル -->
<div class="modal fade" id="contractorDetailsModal" tabindex="-1" aria-labelledby="contractorDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contractorDetailsModalLabel">
                    <i class="fas fa-building"></i> 業者詳細情報
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle"></i> 基本情報</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td><strong>業者名:</strong></td>
                                <td id="modal-contractor-name"></td>
                            </tr>
                            <tr>
                                <td><strong>種別:</strong></td>
                                <td id="modal-payee-type"></td>
                            </tr>
                            <tr>
                                <td><strong>今月対象現場数:</strong></td>
                                <td id="modal-sites-count"></td>
                            </tr>
                            <tr>
                                <td><strong>今月合計金額:</strong></td>
                                <td id="modal-total-amount" class="fw-bold text-primary"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-university"></i> 銀行口座情報</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td><strong>銀行名:</strong></td>
                                <td id="modal-bank-name"></td>
                            </tr>
                            <tr>
                                <td><strong>口座番号:</strong></td>
                                <td id="modal-account-number"></td>
                            </tr>
                            <tr>
                                <td><strong>口座名義:</strong></td>
                                <td id="modal-account-holder"></td>
                            </tr>
                            <tr>
                                <td><strong>支払いサイクル:</strong></td>
                                <td id="modal-payment-cycle"></td>
                            </tr>
                            <tr>
                                <td><strong>支払日:</strong></td>
                                <td id="modal-payment-day"></td>
                            </tr>
                            <tr>
                                <td><strong>次回支払予定日:</strong></td>
                                <td id="modal-auto-payment-date" class="fw-bold text-success"></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                <button type="button" class="btn btn-primary" onclick="editContractor()">
                    <i class="fas fa-edit"></i> 業者情報を編集
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // フォーム要素の自動送信
    const formElements = ['year', 'month', 'status'];

    formElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
            element.addEventListener('change', function() {
                // スムーズなローディング表示
                const submitBtn = document.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 読み込み中...';
                submitBtn.disabled = true;

                setTimeout(() => {
                    this.form.submit();
                }, 100);
            });
        }
    });

    // テーブル行のホバー効果
    const projectRows = document.querySelectorAll('.project-row');
    projectRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(2px)';
        });

        row.addEventListener('mouseleave', function() {
            this.style.transform = 'translateX(0)';
        });
    });

    // 統計カードのアニメーション
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.style.animation = 'fadeInUp 0.6s ease-out forwards';
    });

    // テーブルの横スクロール対応
    const tableWrapper = document.querySelector('.table-responsive');
    if (tableWrapper) {
        let isScrolling = false;

        tableWrapper.addEventListener('scroll', function() {
            if (!isScrolling) {
                window.requestAnimationFrame(function() {
                    const scrollLeft = tableWrapper.scrollLeft;
                    const maxScroll = tableWrapper.scrollWidth - tableWrapper.clientWidth;

                    // スクロール位置に応じた視覚的フィードバック
                    if (scrollLeft > 0) {
                        tableWrapper.classList.add('scrolled-left');
                    } else {
                        tableWrapper.classList.remove('scrolled-left');
                    }

                    if (scrollLeft >= maxScroll - 1) {
                        tableWrapper.classList.add('scrolled-right');
                    } else {
                        tableWrapper.classList.remove('scrolled-right');
                    }

                    isScrolling = false;
                });
            }
            isScrolling = true;
        });
    }
});

// アニメーション定義
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .table-responsive.scrolled-left::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 10px;
        background: linear-gradient(to right, rgba(0,0,0,0.1), transparent);
        z-index: 5;
        pointer-events: none;
    }

    .table-responsive.scrolled-right::after {
        content: "";
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 10px;
        background: linear-gradient(to left, rgba(0,0,0,0.1), transparent);
        z-index: 5;
        pointer-events: none;
    }
`;
document.head.appendChild(style);

// 業者詳細を表示する関数
function showContractorDetails(row) {
    const data = row.dataset;

    // 基本情報
    document.getElementById('modal-contractor-name').textContent = data.contractorName;
    document.getElementById('modal-payee-type').textContent = data.payeeType;
    document.getElementById('modal-sites-count').textContent = data.sitesCount + '件';
    document.getElementById('modal-total-amount').textContent = '¥' + parseInt(data.totalAmount).toLocaleString();

    // 銀行口座情報
    document.getElementById('modal-bank-name').textContent = data.bankName || '未設定';
    document.getElementById('modal-account-number').textContent = data.accountNumber || '未設定';
    document.getElementById('modal-account-holder').textContent = data.accountHolder || '未設定';

    // 支払いサイクルの表示名
    const paymentCycleNames = {
        'monthly': '月払い',
        'bimonthly': '隔月払い',
        'quarterly': '四半期払い',
        'custom': 'その他'
    };
    document.getElementById('modal-payment-cycle').textContent =
        paymentCycleNames[data.paymentCycle] || '未設定';

    document.getElementById('modal-payment-day').textContent =
        data.paymentDay ? data.paymentDay + '日' : '未設定';

    // 次回支払予定日
    if (data.autoPaymentDate) {
        const date = new Date(data.autoPaymentDate);
        document.getElementById('modal-auto-payment-date').textContent =
            date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
    } else {
        document.getElementById('modal-auto-payment-date').textContent = '未設定';
    }

    // モーダルを表示
    const modal = new bootstrap.Modal(document.getElementById('contractorDetailsModal'));
    modal.show();
}

// 業者編集機能（今後実装）
function editContractor() {
    alert('業者編集機能は今後実装予定です');
}
</script>
{% endblock %}