{% extends 'surveys/surveyor_base.html' %}
{% load static %}

{% block title %}èª¿æŸ»è¨˜éŒ²ï¼ˆã‚·ãƒ³ãƒ—ãƒ«UIç‰ˆï¼‰ - ã‚¹ãƒ†ãƒƒãƒ—{{ current_step.step_number }}{% endblock %}

{% block extra_css %}
<style>
    /* ã‚·ãƒ³ãƒ—ãƒ«UIç‰ˆãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–CSS */
    * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        font-family: 'Noto Sans JP', 'Yu Gothic', 'Hiragino Sans', sans-serif;
        font-size: 20px;
        line-height: 1.6;
        background: #f0f4f8;
        margin: 0;
        padding: 0;
        color: #2d3748;
    }

    .mobile-container {
        max-width: 480px;
        margin: 0 auto;
        background: white;
        min-height: 100vh;
        position: relative;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ - å¤§ããã¦è¦‹ã‚„ã™ã */
    .header-simple {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 20px;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒˆãƒƒãƒ—ãƒãƒ¼ */
    .header-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .back-button {
        background: rgba(255,255,255,0.2);
        color: white;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 25px;
        padding: 8px 16px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 80px;
    }

    .back-button:hover {
        background: rgba(255,255,255,0.3);
        transform: translateX(-2px);
    }

    .header-spacer {
        min-width: 80px;
    }

    .site-title {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
        flex: 1;
        text-align: center;
    }

    .progress-text {
        font-size: 18px;
        opacity: 0.9;
    }

    /* è¦–è¦šçš„ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .step-indicators {
        display: flex;
        justify-content: space-between;
        margin: 20px 0;
        padding: 0 10px;
    }

    .step-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        opacity: 0.3;
        transition: all 0.3s ease;
    }

    .step-indicator.current {
        opacity: 1;
        transform: scale(1.2);
    }

    .step-indicator.completed {
        opacity: 1;
    }

    .step-icon {
        font-size: 32px;
        margin-bottom: 8px;
        background: #e2e8f0;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .step-indicator.current .step-icon {
        background: #10b981;
        color: white;
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        animation: pulse 2s infinite;
    }

    .step-indicator.completed .step-icon {
        background: #48bb78;
        color: white;
    }

    .step-label {
        font-size: 14px;
        font-weight: 600;
        color: #2d3748;
        text-align: center;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    /* é€²æ—ãƒãƒ¼ - å¤ªãã¦è¦‹ã‚„ã™ã */
    .progress-big {
        height: 16px;
        background: rgba(255,255,255,0.3);
        border-radius: 10px;
        margin: 15px 0;
        overflow: hidden;
    }

    .progress-fill-big {
        height: 100%;
        background: #48bb78;
        border-radius: 10px;
        transition: width 0.8s ease;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .step-content {
        padding: 30px 20px;
    }

    /* ã‚¹ãƒ†ãƒƒãƒ—ç•ªå· - è¶…å¤§ãã */
    .step-number-big {
        background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        color: white;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        font-weight: bold;
        margin: 0 auto 30px auto;
        box-shadow: 0 8px 20px rgba(237, 137, 54, 0.3);
    }

    /* ã‚¿ã‚¤ãƒˆãƒ« - å¤§ããåˆ†ã‹ã‚Šã‚„ã™ã */
    .step-title-big {
        font-size: 32px;
        font-weight: 700;
        text-align: center;
        margin: 20px 0 40px 0;
        color: #2d3748;
        line-height: 1.3;
    }

    /* èª¬æ˜æ–‡ - èª­ã¿ã‚„ã™ã */
    .instruction-simple {
        background: #edf2f7;
        border-left: 6px solid #10b981;
        padding: 25px;
        margin: 30px 0;
        border-radius: 0 12px 12px 0;
        font-size: 22px;
        line-height: 1.8;
    }

    .instruction-simple h3 {
        font-size: 26px;
        color: #2b6cb0;
        margin: 0 0 15px 0;
    }

    .simple-list {
        list-style: none;
        padding: 0;
        margin: 20px 0;
    }

    .simple-list li {
        padding: 15px 0;
        border-bottom: 2px solid #e2e8f0;
        font-size: 20px;
        display: flex;
        align-items: center;
    }

    .simple-list li::before {
        content: "âœ“";
        background: #48bb78;
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
        font-size: 18px;
    }

    /* æ¸¬å®šã‚¨ãƒªã‚¢ - ã‚·ãƒ³ãƒ—ãƒ«ã§å¤§ãã */
    .measurement-area {
        background: white;
        border: 3px solid #10b981;
        border-radius: 15px;
        padding: 30px;
        margin: 30px 0;
        text-align: center;
    }

    .measurement-input-big {
        margin: 25px 0;
        text-align: center;
    }

    .measurement-input-big label {
        display: block;
        font-size: 24px;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 15px;
    }

    .measurement-input-big input {
        width: 150px;
        height: 70px;
        font-size: 32px;
        text-align: center;
        border: 3px solid #cbd5e0;
        border-radius: 12px;
        background: #f7fafc;
        color: #2d3748;
        font-weight: 600;
    }

    .measurement-input-big input:focus {
        border-color: #10b981;
        outline: none;
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .unit-text {
        font-size: 20px;
        color: #4a5568;
        margin-left: 10px;
        font-weight: 600;
    }

    /* é¸æŠãƒœã‚¿ãƒ³ - è¶…å¤§ãã */
    .choice-buttons {
        margin: 30px 0;
    }

    .choice-btn {
        display: block;
        width: 100%;
        padding: 25px;
        margin: 15px 0;
        background: white;
        border: 3px solid #cbd5e0;
        border-radius: 15px;
        font-size: 22px;
        font-weight: 600;
        color: #2d3748;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .choice-btn:hover,
    .choice-btn.selected {
        border-color: #10b981;
        background: #ebf8ff;
        color: #2b6cb0;
        transform: scale(1.02);
    }

    .choice-btn i {
        font-size: 32px;
        margin-bottom: 10px;
        display: block;
    }

    /* å†™çœŸæ’®å½±ã‚¨ãƒªã‚¢ */
    .photo-area {
        background: #f0fff4;
        border: 4px dashed #48bb78;
        border-radius: 20px;
        padding: 40px 20px;
        margin: 30px 0;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .photo-area:hover {
        background: #e6fffa;
        border-color: #38a169;
    }

    .photo-icon {
        font-size: 64px;
        color: #48bb78;
        margin-bottom: 20px;
    }

    .photo-text {
        font-size: 24px;
        font-weight: 600;
        color: #2f855a;
        margin-bottom: 10px;
    }

    .photo-help {
        font-size: 18px;
        color: #68d391;
    }

    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ - è¶…å¤§ãã */
    .action-area {
        padding: 30px 20px;
        background: #f7fafc;
        margin-top: 40px;
    }

    .big-button {
        width: 100%;
        height: 80px;
        font-size: 24px;
        font-weight: 700;
        border-radius: 20px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin: 15px 0;
    }

    .btn-complete {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
    }

    .btn-complete:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(72, 187, 120, 0.3);
    }

    .btn-complete:disabled {
        background: #cbd5e0;
        color: #a0aec0;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }


    /* ç·Šæ€¥æ™‚ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ */
    .help-button {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: #e53e3e;
        color: white;
        border: none;
        border-radius: 50%;
        width: 70px;
        height: 70px;
        font-size: 28px;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(229, 62, 62, 0.4);
        z-index: 1000;
    }

    .help-button:hover {
        background: #c53030;
        transform: scale(1.1);
    }

    /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£æ”¹å–„ */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .step-content {
        animation: slideIn 0.6s ease-out;
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼ˆé«˜é½¢è€…ãŒå¤œé–“ä½¿ç”¨ã™ã‚‹å ´åˆï¼‰ */
    @media (prefers-color-scheme: dark) {
        body {
            background: #1a202c;
            color: #e2e8f0;
        }

        .mobile-container {
            background: #2d3748;
        }

        .measurement-input-big input {
            background: #4a5568;
            color: #e2e8f0;
            border-color: #718096;
        }

        .choice-btn {
            background: #4a5568;
            color: #e2e8f0;
            border-color: #718096;
        }
    }

    /* èª¿æŸ»æ¦‚è¦ã‚¹ã‚¿ã‚¤ãƒ« */
    .survey-overview-content {
        padding: 20px;
        background: #f8f9fa;
        border-radius: 15px;
        margin: 20px 0;
    }

    .overview-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        border-left: 4px solid #10b981;
    }

    .overview-section h5 {
        font-size: 18px;
        margin-bottom: 15px;
        color: #10b981;
        font-weight: 700;
    }

    .info-box {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
    }

    .info-row {
        display: flex;
        margin-bottom: 10px;
        align-items: center;
    }

    .info-label {
        font-weight: 600;
        color: #4a5568;
        min-width: 80px;
        font-size: 16px;
    }

    .info-value {
        color: #2d3748;
        font-size: 16px;
        flex: 1;
    }

    .workflow-steps {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
    }

    .workflow-step {
        display: flex;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #e2e8f0;
    }

    .workflow-step:last-child {
        border-bottom: none;
    }

    .step-indicator-mini {
        background: #e2e8f0;
        color: #718096;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
        font-size: 14px;
    }

    .step-indicator-mini.current {
        background: #10b981;
        color: white;
    }

    .step-description {
        flex: 1;
    }

    .step-title-mini {
        font-weight: 600;
        color: #2d3748;
        font-size: 14px;
        margin-bottom: 2px;
    }

    .step-subtitle {
        color: #718096;
        font-size: 12px;
    }

    .attention-items {
        background: #fff5f5;
        border: 1px solid #fed7d7;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
    }

    .attention-items h6 {
        color: #c53030;
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 16px;
    }

    .attention-items ul {
        margin: 0;
        padding-left: 20px;
    }

    .attention-items li {
        color: #744210;
        font-size: 14px;
        margin-bottom: 5px;
    }

    /* éƒ¨å±‹é¸æŠæ©Ÿèƒ½ */
    .room-selection-section {
        margin: 30px 0;
    }

    .current-room-display {
        background: white;
        border: 3px solid #10b981;
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
    }

    .room-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .room-name {
        font-size: 24px;
        font-weight: 700;
        color: #2d3748;
    }

    .change-room-btn {
        background: #10b981;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 12px 20px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
    }

    .change-room-btn:hover {
        background: #059669;
        transform: scale(1.05);
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .room-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .room-modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        width: 100%;
        max-width: 400px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .room-modal h4 {
        font-size: 24px;
        margin: 0 0 20px 0;
        text-align: center;
        color: #2d3748;
    }

    .room-list {
        margin: 20px 0;
    }

    .room-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        margin: 10px 0;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .room-item:hover {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .room-item.active {
        border-color: #10b981;
        background: #ecfdf5;
    }

    .room-item span {
        font-size: 20px;
        font-weight: 600;
    }

    .edit-room-btn {
        background: #f59e0b;
        color: white;
        border: none;
        border-radius: 15px;
        padding: 8px 15px;
        font-size: 16px;
        cursor: pointer;
    }

    .add-room-btn {
        width: 100%;
        background: #059669;
        color: white;
        border: none;
        border-radius: 15px;
        padding: 15px;
        font-size: 20px;
        font-weight: 600;
        cursor: pointer;
        margin: 20px 0;
    }

    .add-room-btn:hover {
        background: #047857;
        transform: translateY(-2px);
    }

    .room-modal-actions {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }

    .cancel-btn, .confirm-btn {
        flex: 1;
        padding: 15px;
        border: none;
        border-radius: 15px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
    }

    .cancel-btn {
        background: #e5e7eb;
        color: #374151;
    }

    .confirm-btn {
        background: #10b981;
        color: white;
    }

    .cancel-btn:hover {
        background: #d1d5db;
    }

    .confirm-btn:hover {
        background: #059669;
    }

    /* å£ç®¡ç†æ©Ÿèƒ½ */
    .wall-management-section {
        margin: 30px 0;
    }

    .current-wall-display {
        background: white;
        border: 3px solid #059669;
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
    }

    .wall-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .wall-name {
        font-size: 22px;
        font-weight: 700;
        color: #2d3748;
    }

    .change-wall-btn {
        background: #059669;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 12px 20px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
    }

    .change-wall-btn:hover {
        background: #047857;
        transform: scale(1.05);
    }

    .wall-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .wall-modal-content {
        background: white;
        border-radius: 20px;
        padding: 30px;
        width: 100%;
        max-width: 400px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .wall-list {
        margin: 20px 0;
        max-height: 300px;
        overflow-y: auto;
    }

    .wall-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        margin: 10px 0;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .wall-item:hover {
        border-color: #059669;
        background: #f0fdf4;
    }

    .wall-item.active {
        border-color: #059669;
        background: #ecfdf5;
    }

    .wall-item-content {
        flex: 1;
    }

    .wall-item-name {
        font-size: 18px;
        font-weight: 600;
        color: #2d3748;
    }

    .wall-item-details {
        font-size: 14px;
        color: #6b7280;
        margin-top: 5px;
    }

    .wall-item-actions {
        display: flex;
        gap: 10px;
    }

    .edit-wall-btn, .delete-wall-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        cursor: pointer;
    }

    .edit-wall-btn {
        background: #f59e0b;
        color: white;
    }

    .delete-wall-btn {
        background: #ef4444;
        color: white;
    }

    .add-wall-btn {
        width: 100%;
        background: #047857;
        color: white;
        border: none;
        border-radius: 15px;
        padding: 15px;
        font-size: 20px;
        font-weight: 600;
        cursor: pointer;
        margin: 20px 0;
    }

    .add-wall-btn:hover {
        background: #065f46;
        transform: translateY(-2px);
    }

    /* è©³ç´°ãƒã‚§ãƒƒã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .detailed-check-section {
        margin: 30px 0;
        padding: 20px;
        background: #f8fffe;
        border-radius: 15px;
        border: 2px solid #e6f7f1;
    }

    .check-categories {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .check-category {
        background: white;
        padding: 15px;
        border-radius: 12px;
        border: 1px solid #d1fae5;
    }

    .check-category h5 {
        font-size: 18px;
        font-weight: 600;
        color: #065f46;
        margin: 0 0 15px 0;
        text-align: center;
    }

    .check-items {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .check-item {
        background: #f0fdf4;
        border: 2px solid #bbf7d0;
        padding: 12px 8px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 500;
        color: #065f46;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .check-item:hover {
        background: #dcfce7;
        border-color: #86efac;
        transform: translateY(-1px);
    }

    .check-item.selected {
        background: #10b981;
        color: white;
        border-color: #059669;
        transform: scale(1.05);
    }

    /* å‚™è€ƒæ¬„ */
    .notes-section {
        margin: 30px 0;
        padding: 20px;
        background: #fffef7;
        border-radius: 15px;
        border: 2px solid #fef3c7;
    }

    .notes-input-area {
        margin-top: 15px;
    }

    .notes-input-area textarea {
        width: 100%;
        min-height: 120px;
        font-size: 18px;
        padding: 20px;
        border: 2px solid #fed7aa;
        border-radius: 12px;
        background: white;
        color: #92400e;
        resize: vertical;
        font-family: inherit;
    }

    .notes-input-area textarea:focus {
        outline: none;
        border-color: #f59e0b;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }

    .notes-help {
        margin-top: 10px;
        font-size: 14px;
        color: #92400e;
        text-align: center;
        padding: 8px;
        background: rgba(254, 215, 170, 0.3);
        border-radius: 8px;
    }

    /* éƒ¨å±‹å†™çœŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .room-photo-section {
        margin: 30px 0;
        padding: 20px;
        background: #f0f9ff;
        border-radius: 15px;
        border: 2px solid #bfdbfe;
    }

    .photo-area-enhanced {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        padding: 30px;
        border-radius: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 20px 0;
        border: 3px solid #60a5fa;
        position: relative;
        overflow: hidden;
    }

    .photo-area-enhanced:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
    }

    .photo-area-enhanced .photo-icon {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
    }

    .photo-area-enhanced .photo-text {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .photo-area-enhanced .photo-help {
        font-size: 16px;
        opacity: 0.9;
    }

    .photo-area-enhanced.completed {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-color: #34d399;
    }

    .photo-area-enhanced.completed:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
    }

    .photo-status {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.9);
        color: #059669;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
    }

    .photo-preview {
        margin-top: 20px;
        padding: 20px;
        background: white;
        border-radius: 15px;
        border: 2px solid #e5e7eb;
        text-align: center;
    }

    .photo-preview h5 {
        color: #374151;
        margin-bottom: 15px;
        font-size: 18px;
    }

    .retake-btn {
        background: #f59e0b;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
    }

    .retake-btn:hover {
        background: #d97706;
        transform: translateY(-1px);
    }

    /* ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒœã‚¿ãƒ³ */
    .btn-secondary {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        color: white;
        border: none;
        font-size: 20px;
        font-weight: 600;
        border-radius: 15px;
        padding: 20px 40px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
        display: block;
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="mobile-container">
    <!-- ã‚·ãƒ³ãƒ—ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header-simple">
        <div class="header-top">
            <button class="back-button" onclick="goBack()" title="å‰ã«æˆ»ã‚‹">
                â† æˆ»ã‚‹
            </button>
            <h1 class="site-title">èª¿æŸ»è¨˜éŒ²</h1>
            <div class="header-spacer"></div>
        </div>
        <div class="progress-text">ã‚¹ãƒ†ãƒƒãƒ— {{ current_step.step_number }} / 6</div>

        <!-- è¦–è¦šçš„ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
        <div class="step-indicators">
            {% for step_info in steps_progress %}
                <div class="step-indicator
                    {% if step_info.is_completed %}completed{% endif %}
                    {% if step_info.is_current %}current{% endif %}"
                    onclick="navigateToStep({{ step_info.step.id }})"
                    style="cursor: pointer;">
                    <div class="step-icon">
                        {% if step_info.step.step_type == 'survey_overview' %}
                            ğŸ“‹
                        {% elif step_info.step.step_type == 'room_setup' %}
                            ğŸ 
                        {% elif step_info.step.step_type == 'wall_measurement' %}
                            ğŸ“
                        {% elif step_info.step.step_type == 'condition_check' %}
                            ğŸ”
                        {% elif step_info.step.step_type == 'photo_capture' %}
                            ğŸ“·
                        {% elif step_info.step.step_type == 'damage_assessment' %}
                            ğŸ”§
                        {% else %}
                            âœ…
                        {% endif %}
                    </div>
                    <div class="step-label">
                        {% if step_info.step.step_type == 'survey_overview' %}
                            æ¦‚è¦
                        {% elif step_info.step.step_type == 'room_setup' %}
                            æº–å‚™
                        {% elif step_info.step.step_type == 'wall_measurement' %}
                            æ¸¬å®š
                        {% elif step_info.step.step_type == 'condition_check' %}
                            ç¢ºèª
                        {% elif step_info.step.step_type == 'photo_capture' %}
                            æ’®å½±
                        {% elif step_info.step.step_type == 'damage_assessment' %}
                            ç‚¹æ¤œ
                        {% else %}
                            å®Œäº†
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="progress-big">
            <div class="progress-fill-big" style="width: {{ completion_percentage }}%"></div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="step-content">
        <!-- ã‚¹ãƒ†ãƒƒãƒ—ç•ªå· -->
        <div class="step-number-big">{{ current_step.step_number }}</div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—ã‚¿ã‚¤ãƒˆãƒ« -->
        <h2 class="step-title-big">
            {% if current_step.step_type == 'survey_overview' %}
                èª¿æŸ»æ¦‚è¦ã‚’ç¢ºèª
            {% elif current_step.step_type == 'room_setup' %}
                ãŠéƒ¨å±‹ã®æº–å‚™
            {% elif current_step.step_type == 'wall_measurement' %}
                å£ã‚’æ¸¬ã‚‹
            {% elif current_step.step_type == 'condition_check' %}
                å£ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
            {% elif current_step.step_type == 'photo_capture' %}
                å†™çœŸã‚’æ’®ã‚‹
            {% elif current_step.step_type == 'damage_assessment' %}
                ã‚­ã‚ºã‚’ãƒã‚§ãƒƒã‚¯
            {% else %}
                å®Œäº†ç¢ºèª
            {% endif %}
        </h2>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—åˆ¥ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        {% if current_step.step_type == 'survey_overview' %}
            <!-- èª¿æŸ»æ¦‚è¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="survey-overview-content">
                <!-- ç‰©ä»¶æƒ…å ± -->
                <div class="overview-section">
                    <h5><i class="fas fa-building text-primary"></i> ç‰©ä»¶æƒ…å ±</h5>
                    <div class="info-box">
                        <div class="info-row">
                            <span class="info-label">ç‰©ä»¶å:</span>
                            <span class="info-value">{{ survey.project.site_name }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ä½æ‰€:</span>
                            <span class="info-value">{{ survey.project.site_address }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">èª¿æŸ»å“¡:</span>
                            <span class="info-value">{{ survey.surveyor.name }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">äºˆå®šæ—¥:</span>
                            <span class="info-value">{{ survey.scheduled_date|date:"Yå¹´mæœˆdæ—¥" }}</span>
                        </div>
                    </div>
                </div>

                <!-- ä½œæ¥­å†…å®¹ -->
                <div class="overview-section">
                    <h5><i class="fas fa-clipboard-list text-primary"></i> ä½œæ¥­å†…å®¹</h5>
                    <div class="info-box">
                        <p style="margin: 0; font-size: 16px; line-height: 1.6;">
                            å†…è£…ã®ç¾åœ°èª¿æŸ»ã‚’è¡Œã„ã¾ã™ã€‚å„éƒ¨å±‹ã®å£é¢ã‚’æ¸¬å®šã—ã€ç¾åœ¨ã®çŠ¶æ…‹ã‚’è©³ã—ãè¨˜éŒ²ã—ã¾ã™ã€‚
                            å†™çœŸæ’®å½±ã‚‚å«ã‚ã¦ã€ç´„2æ™‚é–“ç¨‹åº¦ã®ä½œæ¥­ã‚’äºˆå®šã—ã¦ã„ã¾ã™ã€‚
                        </p>
                    </div>
                </div>

                <!-- èª¿æŸ»ã®æµã‚Œ -->
                <div class="overview-section">
                    <h5><i class="fas fa-list-ol text-primary"></i> èª¿æŸ»ã®æµã‚Œ</h5>
                    <div class="workflow-steps">
                        <div class="workflow-step">
                            <div class="step-indicator-mini current">0</div>
                            <div class="step-description">
                                <div class="step-title-mini">èª¿æŸ»æ¦‚è¦</div>
                                <div class="step-subtitle">ç‰©ä»¶æƒ…å ±ã¨ä½œæ¥­å†…å®¹ã‚’ç¢ºèª</div>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="step-indicator-mini">1</div>
                            <div class="step-description">
                                <div class="step-title-mini">éƒ¨å±‹ãƒ»å£é¢ç®¡ç†</div>
                                <div class="step-subtitle">èª¿æŸ»å¯¾è±¡ã®éƒ¨å±‹ã¨å£é¢ã‚’è¨­å®š</div>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="step-indicator-mini">2</div>
                            <div class="step-description">
                                <div class="step-title-mini">å£é¢æ¸¬å®š</div>
                                <div class="step-subtitle">å„å£é¢ã®å¯¸æ³•ã‚’æ¸¬å®š</div>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="step-indicator-mini">3</div>
                            <div class="step-description">
                                <div class="step-title-mini">çŠ¶æ…‹ç¢ºèª</div>
                                <div class="step-subtitle">å£é¢ã®ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèª</div>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="step-indicator-mini">4</div>
                            <div class="step-description">
                                <div class="step-title-mini">è©³ç´°å†™çœŸæ’®å½±</div>
                                <div class="step-subtitle">å£é¢ã¨æå‚·ç®‡æ‰€ã®æ’®å½±</div>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="step-indicator-mini">5</div>
                            <div class="step-description">
                                <div class="step-title-mini">å®Œäº†ç¢ºèª</div>
                                <div class="step-subtitle">å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦å®Œäº†</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ³¨æ„äº‹é … -->
                <div class="overview-section">
                    <h5><i class="fas fa-exclamation-triangle text-warning"></i> æ³¨æ„äº‹é …</h5>
                    <div class="attention-items">
                        <h6>âš ï¸ ä½œæ¥­å‰ã«å¿…ãšã”ç¢ºèªãã ã•ã„</h6>
                        <ul>
                            <li>å®‰å…¨é´ã‚’ç€ç”¨ã—ã€æ»‘ã‚Šã‚„ã™ã„å ´æ‰€ã«æ³¨æ„ã—ã¦ãã ã•ã„</li>
                            <li>ãƒ¡ã‚¸ãƒ£ãƒ¼ãªã©æ¸¬å®šé“å…·ã‚’æº–å‚™ã—ã¦ãã ã•ã„</li>
                            <li>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®ãƒãƒƒãƒ†ãƒªãƒ¼ã‚’ååˆ†ã«å……é›»ã—ã¦ãã ã•ã„</li>
                            <li>å†™çœŸã¯æ˜ã‚‹ã„å ´æ‰€ã§é®®æ˜ã«æ’®å½±ã—ã¦ãã ã•ã„</li>
                            <li>æ¸¬å®šã¯æ­£ç¢ºã«è¡Œã„ã€è¨˜éŒ²æ¼ã‚ŒãŒãªã„ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„</li>
                        </ul>
                    </div>
                </div>
            </div>

        {% elif current_step.step_type == 'room_setup' %}
            <!-- éƒ¨å±‹é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="room-selection-section">
                <h3>ğŸ  èª¿æŸ»ã™ã‚‹éƒ¨å±‹ã‚’é¸ã‚“ã§ãã ã•ã„</h3>

                <div class="current-room-display" id="current-room-display">
                    <div class="room-info">
                        <span class="room-name" id="selected-room-name">
                            {% if current_room %}{{ current_room.room_name }}{% else %}éƒ¨å±‹ã‚’é¸æŠã—ã¦ãã ã•ã„{% endif %}
                        </span>
                        <button class="change-room-btn" onclick="showRoomSelector()">
                            éƒ¨å±‹ã‚’å¤‰æ›´
                        </button>
                    </div>
                </div>

                <!-- éƒ¨å±‹é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
                <div class="room-modal" id="room-modal" style="display: none;">
                    <div class="room-modal-content">
                        <h4>éƒ¨å±‹ã‚’é¸æŠ</h4>

                        <div class="room-list" id="room-list">
                            <!-- æ—¢å­˜ã®éƒ¨å±‹ -->
                            <div class="room-item active" data-room-id="{% if current_room %}{{ current_room.id }}{% endif %}">
                                <span>{% if current_room %}{{ current_room.room_name }}{% else %}ãƒªãƒ“ãƒ³ã‚°{% endif %}</span>
                                <button class="edit-room-btn" onclick="editRoom(this)">ç·¨é›†</button>
                            </div>
                        </div>

                        <button class="add-room-btn" onclick="addNewRoom()">
                            â• æ–°ã—ã„éƒ¨å±‹ã‚’è¿½åŠ 
                        </button>

                        <div class="room-modal-actions">
                            <button class="cancel-btn" onclick="hideRoomSelector()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button class="confirm-btn" onclick="confirmRoomSelection()">æ±ºå®š</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="instruction-simple">
                <h3>ğŸ“‹ éƒ¨å±‹ã®æº–å‚™ã‚’ã—ã¾ã—ã‚‡ã†</h3>
                <ul class="simple-list">
                    <li>é›»æ°—ã‚’ã¤ã‘ã¦æ˜ã‚‹ãã™ã‚‹</li>
                    <li>å¤§ããªå®¶å…·ã‚’å£ã‹ã‚‰é›¢ã™</li>
                    <li>ãƒ¡ã‚¸ãƒ£ãƒ¼ã‚’ç”¨æ„ã™ã‚‹</li>
                    <li>å®‰å…¨ã‚’ç¢ºèªã™ã‚‹</li>
                </ul>
            </div>

            <!-- éƒ¨å±‹å…¨ä½“å†™çœŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="room-photo-section">
                <h4 style="font-size: 20px; margin: 20px 0;">ğŸ“¸ éƒ¨å±‹å…¨ä½“ã®å†™çœŸã‚’æ’®ã‚Šã¾ã—ã‚‡ã†</h4>
                <p style="font-size: 16px; color: #666; margin-bottom: 20px;">
                    éƒ¨å±‹ã®å››éš…ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã€å…¥å£ä»˜è¿‘ã‹ã‚‰æ’®å½±ã—ã¦ãã ã•ã„
                </p>

                <div class="photo-area-enhanced" onclick="capturePhoto('room_overview')" id="room-photo-area">
                    <div class="photo-icon">ğŸ“·</div>
                    <div class="photo-text">ãŠéƒ¨å±‹å…¨ä½“ã®å†™çœŸã‚’æ’®ã‚‹</div>
                    <div class="photo-help">ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ’®å½±</div>
                    <div class="photo-status" id="room-photo-status" style="display: none;">
                        âœ… æ’®å½±æ¸ˆã¿
                    </div>
                </div>

                <!-- æ’®å½±ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
                <div class="photo-preview" id="room-photo-preview" style="display: none;">
                    <h5>ğŸ“· æ’®å½±ã•ã‚ŒãŸå†™çœŸ</h5>
                    <img id="room-photo-img" src="" alt="éƒ¨å±‹å…¨ä½“ã®å†™çœŸ" style="max-width: 100%; border-radius: 10px; margin: 10px 0;">
                    <button class="retake-btn" onclick="retakePhoto('room_overview')">ğŸ“· æ’®ã‚Šç›´ã™</button>
                </div>
            </div>

        {% elif current_step.step_type == 'wall_measurement' %}
            <!-- å£é¸æŠãƒ»ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="wall-management-section">
                <h3>ğŸ§± å£ã‚’é¸æŠãƒ»è¿½åŠ </h3>

                <div class="current-wall-display" id="current-wall-display">
                    <div class="wall-info">
                        <span class="wall-name" id="selected-wall-name">å£1 - åŒ—å´</span>
                        <button class="change-wall-btn" onclick="showWallManager()">
                            å£ã‚’ç®¡ç†
                        </button>
                    </div>
                </div>

                <!-- å£ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
                <div class="wall-modal" id="wall-modal" style="display: none;">
                    <div class="wall-modal-content">
                        <h4>å£ã‚’é¸æŠãƒ»ç®¡ç†</h4>

                        <div class="wall-list" id="wall-list">
                            <!-- å£ãƒªã‚¹ãƒˆãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                        </div>

                        <button class="add-wall-btn" onclick="addNewWall()">
                            â• æ–°ã—ã„å£ã‚’è¿½åŠ 
                        </button>

                        <div class="wall-modal-actions">
                            <button class="cancel-btn" onclick="hideWallManager()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button class="confirm-btn" onclick="confirmWallSelection()">æ±ºå®š</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="instruction-simple">
                <h3>ğŸ“ é¸æŠã—ãŸå£ã®ã‚µã‚¤ã‚ºã‚’æ¸¬ã‚Šã¾ã—ã‚‡ã†</h3>
                <p>ãƒ¡ã‚¸ãƒ£ãƒ¼ã§å£ã®æ¨ªã¨ç¸¦ã‚’æ¸¬ã£ã¦ã€æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            </div>

            <div class="measurement-area">
                <div class="measurement-input-big">
                    <label>å£ã®æ¨ªã®é•·ã•</label>
                    <input type="number" id="wall-width" placeholder="350" step="0.1">
                    <span class="unit-text">cm</span>
                </div>

                <div class="measurement-input-big">
                    <label>å£ã®é«˜ã•</label>
                    <input type="number" id="wall-height" placeholder="240" step="0.1">
                    <span class="unit-text">cm</span>
                </div>

                <div class="measurement-input-big">
                    <label>ãƒ‰ã‚¢ã‚„çª“ã®é¢ç©<br><small>ï¼ˆåˆ†ã‹ã‚‰ãªã‘ã‚Œã°0ã§OKï¼‰</small></label>
                    <input type="number" id="wall-opening" placeholder="0" step="0.1" value="0">
                    <span class="unit-text">ã¡</span>
                </div>
            </div>

            <!-- å£ã®å†™çœŸæ’®å½± -->
            <div class="photo-area" onclick="capturePhoto('wall_condition')">
                <div class="photo-icon">ğŸ“·</div>
                <div class="photo-text">å£ã®å†™çœŸã‚’æ’®ã‚‹</div>
                <div class="photo-help">æ¸¬å®šå‰ã«å£ã®å…¨ä½“å†™çœŸã‚’æ’®å½±</div>
            </div>

        {% elif current_step.step_type == 'condition_check' %}
            <div class="instruction-simple">
                <h3>ğŸ” å£ã®ææ–™ã¨çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯</h3>
                <p>å£ã‚’è»½ãå©ã„ã¦éŸ³ã‚’èãã€è¦‹ãŸç›®ã§åˆ¤æ–­ã—ã¦ãã ã•ã„</p>
            </div>

            <div class="choice-buttons">
                <h4 style="font-size: 22px; margin: 20px 0;">å£ã®ææ–™ã¯ä½•ã§ã™ã‹ï¼Ÿ</h4>
                <button class="choice-btn" data-value="gypsum_board">
                    <i>ğŸ </i>
                    çŸ³è†ãƒœãƒ¼ãƒ‰<br>
                    <small>ï¼ˆä¸€èˆ¬çš„ãªå£ï¼‰</small>
                </button>
                <button class="choice-btn" data-value="concrete">
                    <i>ğŸ§±</i>
                    ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ<br>
                    <small>ï¼ˆç¡¬ã„å£ï¼‰</small>
                </button>
                <button class="choice-btn" data-value="plywood">
                    <i>ğŸŒ³</i>
                    æœ¨ã®æ¿<br>
                    <small>ï¼ˆæœ¨ã§ã§ããŸå£ï¼‰</small>
                </button>
                <button class="choice-btn" data-value="other">
                    <i>â“</i>
                    ã‚ˆãåˆ†ã‹ã‚‰ãªã„
                </button>
            </div>

            <div class="choice-buttons">
                <h4 style="font-size: 22px; margin: 20px 0;">å£ã®çŠ¶æ…‹ã¯ã©ã†ã§ã™ã‹ï¼Ÿ</h4>
                <button class="choice-btn" data-value="good">
                    <i>âœ…</i>
                    ãã‚Œã„<br>
                    <small>ï¼ˆãã®ã¾ã¾ä½¿ãˆã‚‹ï¼‰</small>
                </button>
                <button class="choice-btn" data-value="needs_repair">
                    <i>âš ï¸</i>
                    ç›´ã™å¿…è¦ãŒã‚ã‚‹<br>
                    <small>ï¼ˆã²ã³å‰²ã‚Œã‚„ç©´ãŒã‚ã‚‹ï¼‰</small>
                </button>
            </div>

            <!-- è©³ç´°ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
            <div class="detailed-check-section">
                <h4 style="font-size: 22px; margin: 20px 0;">ğŸ” è©³ã—ããƒã‚§ãƒƒã‚¯ï¼ˆå½“ã¦ã¯ã¾ã‚‹ã‚‚ã®ã‚’ã‚¿ãƒƒãƒ—ï¼‰</h4>

                <div class="check-categories">
                    <div class="check-category">
                        <h5>æ±šã‚Œãƒ»å¤‰è‰²</h5>
                        <div class="check-items">
                            <button class="check-item" data-check="stain">æ±šã‚Œ</button>
                            <button class="check-item" data-check="discoloration">å¤‰è‰²</button>
                            <button class="check-item" data-check="mold">ã‚«ãƒ“</button>
                            <button class="check-item" data-check="water_damage">æ°´æŸ“ã¿</button>
                        </div>
                    </div>

                    <div class="check-category">
                        <h5>ç ´æãƒ»æå‚·</h5>
                        <div class="check-items">
                            <button class="check-item" data-check="crack">ã²ã³å‰²ã‚Œ</button>
                            <button class="check-item" data-check="hole">ç©´</button>
                            <button class="check-item" data-check="peel">ã¯ãŒã‚Œ</button>
                            <button class="check-item" data-check="dent">ã¸ã“ã¿</button>
                        </div>
                    </div>

                    <div class="check-category">
                        <h5>ãã®ä»–</h5>
                        <div class="check-items">
                            <button class="check-item" data-check="scratch">ã‚­ã‚º</button>
                            <button class="check-item" data-check="nail_hole">é‡˜ç©´</button>
                            <button class="check-item" data-check="none">å•é¡Œãªã—</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å‚™è€ƒæ¬„ -->
            <div class="notes-section">
                <h4 style="font-size: 22px; margin: 20px 0;">ğŸ“ æ°—ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Œã°è¨˜éŒ²</h4>
                <div class="notes-input-area">
                    <textarea id="wall-notes"
                              placeholder="ä¾‹: å³ä¸Šã«å°ã•ãªç©´ãŒã‚ã‚‹&#10;ä¾‹: å…¨ä½“çš„ã«å°‘ã—æ±šã‚Œã¦ã„ã‚‹&#10;ä¾‹: ã‚³ãƒ³ã‚»ãƒ³ãƒˆå‘¨ã‚Šã«ã²ã³"
                              rows="4"></textarea>
                    <div class="notes-help">
                        ç´°ã‹ã„ã“ã¨ã§ã‚‚è¨˜éŒ²ã—ã¦ãŠãã¨ã€å¾Œã§å½¹ã«ç«‹ã¡ã¾ã™
                    </div>
                </div>
            </div>

        {% elif current_step.step_type == 'photo_capture' %}
            <div class="instruction-simple">
                <h3>ğŸ“¸ å£ã®å†™çœŸã‚’æ’®ã‚Šã¾ã—ã‚‡ã†</h3>
                <p>æ˜ã‚‹ã„å ´æ‰€ã§ã€å£å…¨ä½“ãŒã‚ˆãè¦‹ãˆã‚‹ã‚ˆã†ã«æ’®å½±ã—ã¦ãã ã•ã„</p>
            </div>

            <div class="photo-area" onclick="capturePhoto('wall_condition')">
                <div class="photo-icon">ğŸ“·</div>
                <div class="photo-text">å£å…¨ä½“ã®å†™çœŸ</div>
                <div class="photo-help">ã‚¿ãƒƒãƒ—ã—ã¦æ’®å½±</div>
            </div>

            <div class="photo-area" onclick="capturePhoto('damage_detail')">
                <div class="photo-icon">ğŸ”</div>
                <div class="photo-text">ã‚­ã‚ºã‚„æ±šã‚Œã®å†™çœŸ</div>
                <div class="photo-help">æ°—ã«ãªã‚‹éƒ¨åˆ†ãŒã‚ã‚Œã°æ’®å½±</div>
            </div>

        {% elif current_step.step_type == 'damage_assessment' %}
            <div class="instruction-simple">
                <h3>ğŸ” å£ã®ã‚­ã‚ºã‚„æ±šã‚Œã‚’ãƒã‚§ãƒƒã‚¯</h3>
                <p>å½“ã¦ã¯ã¾ã‚‹ã‚‚ã®ãŒã‚ã‚Œã°é¸ã‚“ã§ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠOKï¼‰</p>
            </div>

            <div class="choice-buttons">
                <button class="choice-btn damage-choice" data-value="stain_discoloration">
                    <i>ğŸŸ¤</i>
                    æ±šã‚Œãƒ»è‰²ã‚ã›
                </button>
                <button class="choice-btn damage-choice" data-value="tear_peel">
                    <i>ğŸ“„</i>
                    ç ´ã‚Œãƒ»ã‚ãã‚Œ
                </button>
                <button class="choice-btn damage-choice" data-value="nail_holes">
                    <i>ğŸ“Œ</i>
                    ç”»é‹²ã®ç©´
                </button>
                <button class="choice-btn damage-choice" data-value="large_holes">
                    <i>âš«</i>
                    å¤§ããªç©´
                </button>
                <button class="choice-btn damage-choice" data-value="none">
                    <i>âœ¨</i>
                    ç‰¹ã«å•é¡Œãªã—
                </button>
            </div>

        {% else %}
            <div class="instruction-simple">
                <h3>âœ… ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼</h3>
                <p>ã™ã¹ã¦ã®èª¿æŸ»ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ã€Œå®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
        {% endif %}

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ -->
        <div class="action-area">
            {% if current_step.step_type == 'survey_overview' %}
                <button class="big-button btn-complete" onclick="completeStep('{{ current_step.id }}')">
                    <i class="fas fa-play"></i> èª¿æŸ»é–‹å§‹
                </button>
            {% elif current_step.step_type == 'room_setup' %}
                <button class="big-button btn-complete" onclick="completeStep('{{ current_step.id }}')">
                    <i class="fas fa-check"></i> æº–å‚™ã§ãã¾ã—ãŸ
                </button>
            {% elif current_step.step_type == 'wall_measurement' %}
                <button class="big-button btn-complete" onclick="completeMeasurement()">
                    <i class="fas fa-save"></i> æ¸¬å®šå®Œäº†
                </button>
            {% elif current_step.step_type == 'condition_check' %}
                <button class="big-button btn-complete" onclick="completeConditionCheck()" disabled id="condition-complete-btn">
                    <i class="fas fa-check"></i> ãƒã‚§ãƒƒã‚¯å®Œäº†
                </button>
            {% elif current_step.step_type == 'photo_capture' %}
                <button class="big-button btn-complete" onclick="completePhotoCapture()">
                    <i class="fas fa-images"></i> æ’®å½±å®Œäº†
                </button>
            {% elif current_step.step_type == 'damage_assessment' %}
                <button class="big-button btn-complete" onclick="completeDamageAssessment()">
                    <i class="fas fa-check"></i> ãƒã‚§ãƒƒã‚¯å®Œäº†
                </button>
            {% else %}
                <div class="final-completion-area">
                    <button class="big-button btn-complete" onclick="completeStep('{{ current_step.id }}')">
                        <i class="fas fa-flag-checkered"></i> èª¿æŸ»å®Œäº†
                    </button>
                    <button class="big-button btn-secondary" onclick="goToSurveyList()" style="margin-top: 15px;">
                        <i class="fas fa-list"></i> èª¿æŸ»ä¸€è¦§ã«æˆ»ã‚‹
                    </button>
                </div>
            {% endif %}
        </div>
    </div>


    <!-- ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ -->
    <button class="help-button" onclick="showHelp()" title="å›°ã£ãŸæ™‚ã¯ã“ã“ã‚’ã‚¿ãƒƒãƒ—">
        ğŸ†˜
    </button>
</div>

<!-- Hidden file input for photo capture -->
<input type="file" id="photo-input" accept="image/*" capture="environment" style="display: none;">

{% endblock %}

{% block extra_js %}
<script>
let selectedFoundationType = null;
let selectedFoundationCondition = null;
let selectedDamageTypes = [];
let selectedDetailedChecks = [];
let wallNotes = '';
let roomPhotoTaken = false;
let currentStepId = {{ current_step.id }};
let surveyId = {{ survey.id }};

// é¸æŠãƒœã‚¿ãƒ³ã®å‡¦ç†
document.querySelectorAll('.choice-btn').forEach(button => {
    button.addEventListener('click', function() {
        const value = this.dataset.value;

        if (this.classList.contains('damage-choice')) {
            // æå‚·è©•ä¾¡ã§ã¯è¤‡æ•°é¸æŠå¯èƒ½
            if (value === 'none') {
                // ã€Œå•é¡Œãªã—ã€ã‚’é¸ã‚“ã ã‚‰ä»–ã‚’å…¨ã¦ã‚¯ãƒªã‚¢
                selectedDamageTypes = ['none'];
                document.querySelectorAll('.damage-choice').forEach(btn => {
                    btn.classList.remove('selected');
                });
                this.classList.add('selected');
            } else {
                // ä»–ã®é …ç›®ã‚’é¸ã‚“ã ã‚‰ã€Œå•é¡Œãªã—ã€ã‚’ã‚¯ãƒªã‚¢
                const noneBtn = document.querySelector('.damage-choice[data-value="none"]');
                if (noneBtn) noneBtn.classList.remove('selected');

                const index = selectedDamageTypes.indexOf('none');
                if (index > -1) selectedDamageTypes.splice(index, 1);

                // ãƒˆã‚°ãƒ«
                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                    const damageIndex = selectedDamageTypes.indexOf(value);
                    if (damageIndex > -1) selectedDamageTypes.splice(damageIndex, 1);
                } else {
                    this.classList.add('selected');
                    selectedDamageTypes.push(value);
                }
            }
        } else {
            // é€šå¸¸ã®é¸æŠï¼ˆå˜ä¸€é¸æŠï¼‰
            const parentGroup = this.parentElement;
            parentGroup.querySelectorAll('.choice-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            this.classList.add('selected');

            // å€¤ã‚’ä¿å­˜
            if (['gypsum_board', 'concrete', 'plywood', 'other'].includes(value)) {
                selectedFoundationType = value;
            } else if (['good', 'needs_repair'].includes(value)) {
                selectedFoundationCondition = value;
            }

            // æ¡ä»¶ãƒã‚§ãƒƒã‚¯å®Œäº†ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
            if (selectedFoundationType && selectedFoundationCondition) {
                document.getElementById('condition-complete-btn').disabled = false;
            }
        }
    });
});

// è©³ç´°ãƒã‚§ãƒƒã‚¯é …ç›®ã®å‡¦ç†
document.querySelectorAll('.check-item').forEach(button => {
    button.addEventListener('click', function() {
        const checkValue = this.dataset.check;

        if (checkValue === 'none') {
            // ã€Œå•é¡Œãªã—ã€ã‚’é¸ã‚“ã ã‚‰ä»–ã‚’å…¨ã¦ã‚¯ãƒªã‚¢
            selectedDetailedChecks = ['none'];
            document.querySelectorAll('.check-item').forEach(btn => {
                btn.classList.remove('selected');
            });
            this.classList.add('selected');
        } else {
            // ä»–ã®é …ç›®ã‚’é¸ã‚“ã ã‚‰ã€Œå•é¡Œãªã—ã€ã‚’ã‚¯ãƒªã‚¢
            const noneBtn = document.querySelector('.check-item[data-check="none"]');
            if (noneBtn) noneBtn.classList.remove('selected');

            const index = selectedDetailedChecks.indexOf('none');
            if (index > -1) selectedDetailedChecks.splice(index, 1);

            // ãƒˆã‚°ãƒ«
            if (this.classList.contains('selected')) {
                this.classList.remove('selected');
                const checkIndex = selectedDetailedChecks.indexOf(checkValue);
                if (checkIndex > -1) selectedDetailedChecks.splice(checkIndex, 1);
            } else {
                this.classList.add('selected');
                selectedDetailedChecks.push(checkValue);
            }
        }

        // æ¡ä»¶ãƒã‚§ãƒƒã‚¯å®Œäº†ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
        checkConditionComplete();
    });
});

// å‚™è€ƒæ¬„ã®å‡¦ç†
const notesTextarea = document.getElementById('wall-notes');
if (notesTextarea) {
    notesTextarea.addEventListener('input', function() {
        wallNotes = this.value;
    });
}

// æ¡ä»¶ãƒã‚§ãƒƒã‚¯å®Œäº†ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–ãƒã‚§ãƒƒã‚¯
function checkConditionComplete() {
    const button = document.getElementById('condition-complete-btn');
    if (button && selectedFoundationType && selectedFoundationCondition) {
        button.disabled = false;
    }
}

// å†™çœŸæ’®å½±
function capturePhoto(photoType) {
    const input = document.getElementById('photo-input');
    input.dataset.photoType = photoType;
    input.click();
}

document.getElementById('photo-input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const photoType = this.dataset.photoType;

        // Show preview for room overview photos
        if (photoType === 'room_overview') {
            showRoomPhotoPreview(file);
        }

        uploadPhoto(file, photoType);
    }
});

// å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
function uploadPhoto(file, photoType) {
    const formData = new FormData();
    formData.append('photo', file);
    formData.append('photo_type', photoType);

    fetch(`/surveys/${surveyId}/step/${currentStepId}/upload-photo/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('å†™çœŸã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        } else {
            showError('å†™çœŸã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    });
}

// ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†é–¢æ•°ï¼ˆéŸ³å£°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä»˜ãï¼‰
function completeStep(stepId) {
    playClickSound(); // ã‚¯ãƒªãƒƒã‚¯éŸ³

    fetch(`/surveys/${surveyId}/step/${stepId}/complete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            playSuccessSound();
            if (data.next_step_id) {
                speak('æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã¿ã¾ã™');
                setTimeout(() => {
                    window.location.href = `?step=${data.next_step_id}`;
                }, 2000);
            } else {
                speak('ã™ã¹ã¦ã®èª¿æŸ»ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãŠç–²ã‚Œã•ã¾ã§ã—ãŸ');
                showSuccess('èª¿æŸ»ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼');
                setTimeout(() => {
                    window.location.href = `/surveys/demo/`;
                }, 3000);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        playErrorSound();
        speak('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„');
    });
}

function completeMeasurement() {
    const width = document.getElementById('wall-width').value;
    const height = document.getElementById('wall-height').value;
    const opening = document.getElementById('wall-opening').value || 0;

    if (!width || !height) {
        showError('æ¨ªã®é•·ã•ã¨é«˜ã•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    const data = {
        width: parseFloat(width),
        height: parseFloat(height),
        opening_area: parseFloat(opening)
    };

    fetch(`/surveys/${surveyId}/step/${currentStepId}/complete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('æ¸¬å®šå®Œäº†ï¼æ¬¡ã¸é€²ã¿ã¾ã™');
            setTimeout(() => {
                if (data.next_step_id) {
                    window.location.href = `?step=${data.next_step_id}`;
                }
            }, 1000);
        }
    });
}

function completeConditionCheck() {
    const data = {
        foundation_type: selectedFoundationType,
        foundation_condition: selectedFoundationCondition,
        detailed_checks: selectedDetailedChecks,
        wall_notes: wallNotes
    };

    fetch(`/surveys/${surveyId}/step/${currentStepId}/complete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼æ¬¡ã¸é€²ã¿ã¾ã™');
            setTimeout(() => {
                if (data.next_step_id) {
                    window.location.href = `?step=${data.next_step_id}`;
                }
            }, 1000);
        }
    });
}

function completePhotoCapture() {
    showSuccess('å†™çœŸæ’®å½±å®Œäº†ï¼æ¬¡ã¸é€²ã¿ã¾ã™');
    setTimeout(() => {
        completeStep(currentStepId);
    }, 1000);
}

function completeDamageAssessment() {
    const data = {
        damage_types: selectedDamageTypes
    };

    fetch(`/surveys/${surveyId}/step/${currentStepId}/complete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼æ¬¡ã¸é€²ã¿ã¾ã™');
            setTimeout(() => {
                if (data.next_step_id) {
                    window.location.href = `?step=${data.next_step_id}`;
                }
            }, 1000);
        }
    });
}

// éŸ³å£°ã‚¬ã‚¤ãƒ‰æ©Ÿèƒ½ã®å¼·åŒ–ç‰ˆ
function playVoiceGuide(customMessage = null) {
    const stepType = '{{ current_step.step_type }}';
    let message = customMessage;

    if (!message) {
        switch(stepType) {
            case 'room_setup':
                message = 'ã‚¹ãƒ†ãƒƒãƒ—1ã€ãŠéƒ¨å±‹ã®æº–å‚™ã‚’ã—ã¾ã—ã‚‡ã†ã€‚ã¾ãšé›»æ°—ã‚’ã¤ã‘ã¦æ˜ã‚‹ãã—ã¦ãã ã•ã„ã€‚æ¬¡ã«å¤§ããªå®¶å…·ã‚’å£ã‹ã‚‰é›¢ã—ã¦ãã ã•ã„ã€‚ãƒ¡ã‚¸ãƒ£ãƒ¼ã‚’ç”¨æ„ã—ã¦ã€å®‰å…¨ã‚’ç¢ºèªã—ãŸã‚‰å†™çœŸã‚’æ’®ã£ã¦ãã ã•ã„ã€‚';
                break;
            case 'wall_measurement':
                message = 'ã‚¹ãƒ†ãƒƒãƒ—2ã€å£ã®ã‚µã‚¤ã‚ºã‚’æ¸¬ã‚Šã¾ã—ã‚‡ã†ã€‚ãƒ¡ã‚¸ãƒ£ãƒ¼ã§å£ã®æ¨ªã®é•·ã•ã‚’æ¸¬ã£ã¦ã€æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚æ¬¡ã«å£ã®é«˜ã•ã‚’æ¸¬ã£ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãƒ‰ã‚¢ã‚„çª“ã®é¢ç©ã¯åˆ†ã‹ã‚‰ãªã‘ã‚Œã°0ã§å¤§ä¸ˆå¤«ã§ã™ã€‚';
                break;
            case 'condition_check':
                message = 'ã‚¹ãƒ†ãƒƒãƒ—3ã€å£ã®ææ–™ã¨çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚å£ã‚’è»½ãå©ã„ã¦éŸ³ã‚’èã„ã¦ãã ã•ã„ã€‚çŸ³è†ãƒœãƒ¼ãƒ‰ã€ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆã€ãƒ™ãƒ‹ãƒ¤æ¿ã®ä¸­ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„ã€‚åˆ†ã‹ã‚‰ãªã‘ã‚Œã°çŸ³è†ãƒœãƒ¼ãƒ‰ã§å¤§ä¸ˆå¤«ã§ã™ã€‚';
                break;
            case 'photo_capture':
                message = 'ã‚¹ãƒ†ãƒƒãƒ—4ã€å£ã®å†™çœŸã‚’æ’®å½±ã—ã¦ãã ã•ã„ã€‚ã§ãã‚‹ã ã‘æ˜ã‚‹ãã¦ã€å£å…¨ä½“ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«æ’®ã£ã¦ãã ã•ã„ã€‚å†™çœŸã‚¨ãƒªã‚¢ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨æ’®å½±ã§ãã¾ã™ã€‚';
                break;
            case 'damage_assessment':
                message = 'ã‚¹ãƒ†ãƒƒãƒ—5ã€å£ã«ã‚­ã‚ºã‚„æ±šã‚ŒãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚ã²ã³å‰²ã‚Œã€æ±šã‚Œã€ç©´ã€ã¯ãŒã‚ŒãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚å•é¡ŒãŒãªã‘ã‚Œã°ã€Œå•é¡Œãªã—ã€ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚';
                break;
            default:
                message = 'ã‚¹ãƒ†ãƒƒãƒ—6ã€ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚ã™ã¹ã¦ã®èª¿æŸ»ãŒå®Œäº†ã—ã¾ã—ãŸã€‚èª¿æŸ»å®Œäº†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚';
        }
    }

    speak(message);
}

// éŸ³å£°åˆæˆæ©Ÿèƒ½ã‚’å‰Šé™¤ã—ã€è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«ç½®ãæ›ãˆ
function speak(message, rate = 0.7) {
    // éŸ³å£°ã®ä»£ã‚ã‚Šã«è¦–è¦šçš„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    showMessage(message, 'info');
}

function showMessage(message, type) {
    const msgDiv = document.createElement('div');
    msgDiv.textContent = message;
    msgDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#e53e3e' : '#3b82f6'};
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        max-width: 300px;
        text-align: center;
    `;
    document.body.appendChild(msgDiv);

    setTimeout(() => {
        msgDiv.remove();
    }, 3000);
}

// åŠ¹æœéŸ³ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆéŸ³å£°ãªã—ç‰ˆï¼‰
function playSuccessSound() {
    showMessage('ã‚ˆãã§ãã¾ã—ãŸï¼', 'success');
}

function playErrorSound() {
    showMessage('ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ãã ã•ã„', 'error');
}

function playClickSound() {
    // éŸ³å£°ã®ä»£ã‚ã‚Šã«ç°¡å˜ãªè¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆä½•ã‚‚ã—ãªã„ï¼‰
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†ï¼ˆéŸ³å£°ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ãªã—ï¼‰
document.addEventListener('DOMContentLoaded', function() {
    // éŸ³å£°ã‚¬ã‚¤ãƒ‰ã®ä»£ã‚ã‚Šã«ã€å¿…è¦ã«å¿œã˜ã¦è¦–è¦šçš„ãªèª¬æ˜ã‚’è¡¨ç¤º
});

// éƒ¨å±‹ç®¡ç†æ©Ÿèƒ½
let rooms = [
    { id: {% if current_room %}{{ current_room.id }}{% else %}1{% endif %}, name: '{% if current_room %}{{ current_room.room_name }}{% else %}ãƒªãƒ“ãƒ³ã‚°{% endif %}' }
];
let selectedRoomId = {% if current_room %}{{ current_room.id }}{% else %}1{% endif %};

function showRoomSelector() {
    playClickSound();
    document.getElementById('room-modal').style.display = 'flex';
    renderRoomList();
}

function hideRoomSelector() {
    playClickSound();
    document.getElementById('room-modal').style.display = 'none';
}

function renderRoomList() {
    const roomList = document.getElementById('room-list');
    roomList.innerHTML = '';

    rooms.forEach(room => {
        const roomItem = document.createElement('div');
        roomItem.className = `room-item ${room.id === selectedRoomId ? 'active' : ''}`;
        roomItem.dataset.roomId = room.id;
        roomItem.innerHTML = `
            <span>${room.name}</span>
            <button class="edit-room-btn" onclick="editRoom(${room.id})">ç·¨é›†</button>
        `;

        roomItem.addEventListener('click', function(e) {
            if (e.target.classList.contains('edit-room-btn')) return;

            // ä»–ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.room-item').forEach(item => {
                item.classList.remove('active');
            });

            // ç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠ
            this.classList.add('active');
            selectedRoomId = parseInt(this.dataset.roomId);
        });

        roomList.appendChild(roomItem);
    });
}

function addNewRoom() {
    playClickSound();
    const roomName = prompt('æ–°ã—ã„éƒ¨å±‹ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', '');

    if (roomName && roomName.trim()) {
        const newId = Math.max(...rooms.map(r => r.id)) + 1;
        rooms.push({
            id: newId,
            name: roomName.trim()
        });

        // æ–°ã—ã„éƒ¨å±‹ã‚’è‡ªå‹•é¸æŠ
        selectedRoomId = newId;
        renderRoomList();

        speak(`${roomName}ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
    }
}

function editRoom(roomId) {
    playClickSound();
    const room = rooms.find(r => r.id === roomId);
    if (!room) return;

    const newName = prompt('éƒ¨å±‹åã‚’ç·¨é›†:', room.name);
    if (newName && newName.trim() && newName.trim() !== room.name) {
        room.name = newName.trim();
        renderRoomList();

        // è¡¨ç¤ºä¸­ã®éƒ¨å±‹åã‚‚æ›´æ–°
        if (roomId === selectedRoomId) {
            document.getElementById('selected-room-name').textContent = room.name;
        }

        speak(`éƒ¨å±‹åã‚’${newName}ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
    }
}

function confirmRoomSelection() {
    playClickSound();
    const selectedRoom = rooms.find(r => r.id === selectedRoomId);

    if (selectedRoom) {
        document.getElementById('selected-room-name').textContent = selectedRoom.name;
        hideRoomSelector();
        speak(`${selectedRoom.name}ã‚’é¸æŠã—ã¾ã—ãŸ`);
    }
}

// å£ç®¡ç†æ©Ÿèƒ½
let walls = [
    { id: 1, name: 'å£1 - åŒ—å´', direction: 'åŒ—', width: null, height: null, condition: null }
];
let selectedWallId = 1;

function showWallManager() {
    playClickSound();
    document.getElementById('wall-modal').style.display = 'flex';
    renderWallList();
}

function hideWallManager() {
    playClickSound();
    document.getElementById('wall-modal').style.display = 'none';
}

function renderWallList() {
    const wallList = document.getElementById('wall-list');
    wallList.innerHTML = '';

    walls.forEach(wall => {
        const wallItem = document.createElement('div');
        wallItem.className = `wall-item ${wall.id === selectedWallId ? 'active' : ''}`;
        wallItem.dataset.wallId = wall.id;

        let details = '';
        if (wall.width && wall.height) {
            details = `${wall.width}cm Ã— ${wall.height}cm`;
        } else {
            details = 'æœªæ¸¬å®š';
        }

        wallItem.innerHTML = `
            <div class="wall-item-content">
                <div class="wall-item-name">${wall.name}</div>
                <div class="wall-item-details">${details}</div>
            </div>
            <div class="wall-item-actions">
                <button class="edit-wall-btn" onclick="editWall(${wall.id})">ç·¨é›†</button>
                <button class="delete-wall-btn" onclick="deleteWall(${wall.id})">å‰Šé™¤</button>
            </div>
        `;

        wallItem.addEventListener('click', function(e) {
            if (e.target.classList.contains('edit-wall-btn') ||
                e.target.classList.contains('delete-wall-btn')) return;

            // ä»–ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.wall-item').forEach(item => {
                item.classList.remove('active');
            });

            // ç¾åœ¨ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’é¸æŠ
            this.classList.add('active');
            selectedWallId = parseInt(this.dataset.wallId);
        });

        wallList.appendChild(wallItem);
    });
}

function addNewWall() {
    playClickSound();

    const directions = ['åŒ—', 'å—', 'æ±', 'è¥¿', 'åŒ—æ±', 'åŒ—è¥¿', 'å—æ±', 'å—è¥¿'];
    let directionText = directions.join('ã€');

    const wallName = prompt(`æ–°ã—ã„å£ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:\nä¾‹: å£2 - æ±å´`, '');

    if (wallName && wallName.trim()) {
        const newId = Math.max(...walls.map(w => w.id)) + 1;
        walls.push({
            id: newId,
            name: wallName.trim(),
            direction: 'æœªè¨­å®š',
            width: null,
            height: null,
            condition: null
        });

        // æ–°ã—ã„å£ã‚’è‡ªå‹•é¸æŠ
        selectedWallId = newId;
        renderWallList();

        speak(`${wallName}ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
    }
}

function editWall(wallId) {
    playClickSound();
    const wall = walls.find(w => w.id === wallId);
    if (!wall) return;

    const newName = prompt('å£ã®åå‰ã‚’ç·¨é›†:', wall.name);
    if (newName && newName.trim() && newName.trim() !== wall.name) {
        wall.name = newName.trim();
        renderWallList();

        // è¡¨ç¤ºä¸­ã®å£åã‚‚æ›´æ–°
        if (wallId === selectedWallId) {
            document.getElementById('selected-wall-name').textContent = wall.name;
        }

        speak(`å£åã‚’${newName}ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
    }
}

function deleteWall(wallId) {
    playClickSound();

    if (walls.length <= 1) {
        speak('æœ€ä½1ã¤ã®å£ã¯å¿…è¦ã§ã™');
        return;
    }

    const wall = walls.find(w => w.id === wallId);
    if (!wall) return;

    if (confirm(`${wall.name}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        walls = walls.filter(w => w.id !== wallId);

        // å‰Šé™¤ã—ãŸå£ãŒé¸æŠä¸­ã ã£ãŸå ´åˆã€æœ€åˆã®å£ã‚’é¸æŠ
        if (wallId === selectedWallId) {
            selectedWallId = walls[0].id;
            document.getElementById('selected-wall-name').textContent = walls[0].name;
        }

        renderWallList();
        speak(`${wall.name}ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
    }
}

function confirmWallSelection() {
    playClickSound();
    const selectedWall = walls.find(w => w.id === selectedWallId);

    if (selectedWall) {
        document.getElementById('selected-wall-name').textContent = selectedWall.name;

        // æ—¢å­˜ã®æ¸¬å®šå€¤ãŒã‚ã‚Œã°å¾©å…ƒ
        if (selectedWall.width) {
            document.getElementById('wall-width').value = selectedWall.width;
        }
        if (selectedWall.height) {
            document.getElementById('wall-height').value = selectedWall.height;
        }

        hideWallManager();
        speak(`${selectedWall.name}ã‚’é¸æŠã—ã¾ã—ãŸ`);
    }
}

// æ¸¬å®šå€¤ä¿å­˜æ©Ÿèƒ½
function saveMeasurement() {
    const selectedWall = walls.find(w => w.id === selectedWallId);
    if (!selectedWall) return;

    const width = document.getElementById('wall-width').value;
    const height = document.getElementById('wall-height').value;

    if (width) selectedWall.width = parseFloat(width);
    if (height) selectedWall.height = parseFloat(height);
}

// å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´æ™‚ã«è‡ªå‹•ä¿å­˜
document.addEventListener('DOMContentLoaded', function() {
    const widthInput = document.getElementById('wall-width');
    const heightInput = document.getElementById('wall-height');

    if (widthInput) {
        widthInput.addEventListener('input', saveMeasurement);
    }
    if (heightInput) {
        heightInput.addEventListener('input', saveMeasurement);
    }
});

// ãƒ˜ãƒ«ãƒ—æ©Ÿèƒ½
function showHelp() {
    const helpMessage = 'åˆ†ã‹ã‚‰ãªã„ã“ã¨ãŒã‚ã‚Œã°ã€äº‹å‹™æ‰€ã«é›»è©±ã—ã¦ãã ã•ã„ã€‚\né›»è©±ç•ªå·: 03-1234-5678\n\nã¾ãŸã¯ã€è¿‘ãã®äººã«èã„ã¦ã¿ã¦ãã ã•ã„ã€‚';
    alert(helpMessage);
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showSuccess(message) {
    // å¤§ããªã‚¢ãƒ©ãƒ¼ãƒˆé¢¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const alertDiv = document.createElement('div');
    alertDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #48bb78;
        color: white;
        padding: 30px;
        border-radius: 20px;
        font-size: 24px;
        font-weight: 600;
        z-index: 10000;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    `;
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);

    setTimeout(() => {
        document.body.removeChild(alertDiv);
    }, 2000);
}

function showError(message) {
    const alertDiv = document.createElement('div');
    alertDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #e53e3e;
        color: white;
        padding: 30px;
        border-radius: 20px;
        font-size: 24px;
        font-weight: 600;
        z-index: 10000;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    `;
    alertDiv.textContent = message;
    document.body.appendChild(alertDiv);

    setTimeout(() => {
        document.body.removeChild(alertDiv);
    }, 3000);
}

// æˆ»ã‚‹ãƒœã‚¿ãƒ³æ©Ÿèƒ½
function goBack() {
    playClickSound();

    const currentStep = {{ current_step.step_number }};
    const stepType = '{{ current_step.step_type }}';

    // æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—ã®å ´åˆã¯ç¢ºèªã—ã¦èª¿æŸ»ä¸€è¦§ã«æˆ»ã‚‹
    if (stepType === 'final_review' || currentStep >= 6) {
        if (confirm('èª¿æŸ»ä¸€è¦§ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
            window.location.href = '/surveys/demo/';
        }
        return;
    }

    if (currentStep <= 0) {
        // æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã®å ´åˆã¯èª¿æŸ»ä¸€è¦§ã«æˆ»ã‚‹
        if (confirm('èª¿æŸ»ä¸€è¦§ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
            window.location.href = '/surveys/demo/';
        }
    } else {
        // å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã«æˆ»ã‚‹
        const steps = [
            {% for step_info in steps_progress %}
                {
                    id: {{ step_info.step.id }},
                    number: {{ step_info.step.step_number }},
                    completed: {{ step_info.is_completed|yesno:"true,false" }}
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ¢ã™
        for (let i = steps.length - 1; i >= 0; i--) {
            if (steps[i].number < currentStep) {
                window.location.href = `?step=${steps[i].id}`;
                break;
            }
        }
    }
}

// èª¿æŸ»ä¸€è¦§ã«æˆ»ã‚‹
function goToSurveyList() {
    playClickSound();
    if (confirm('èª¿æŸ»ä¸€è¦§ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
        window.location.href = '/surveys/demo/';
    }
}

// éƒ¨å±‹å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
function showRoomPhotoPreview(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const photoArea = document.getElementById('room-photo-area');
        const previewArea = document.getElementById('room-photo-preview');
        const photoImg = document.getElementById('room-photo-img');
        const photoStatus = document.getElementById('room-photo-status');

        // å†™çœŸã‚’è¡¨ç¤º
        photoImg.src = e.target.result;
        previewArea.style.display = 'block';

        // æ’®å½±ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´
        photoArea.classList.add('completed');
        photoStatus.style.display = 'block';

        // ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
        roomPhotoTaken = true;

        // éŸ³å£°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        speak('éƒ¨å±‹ã®å†™çœŸãŒæ’®å½±ã•ã‚Œã¾ã—ãŸã€‚è‰¯ã„å†™çœŸã§ã™ã€‚');
        showSuccess('ğŸ“· å†™çœŸæ’®å½±å®Œäº†ï¼');
    };
    reader.readAsDataURL(file);
}

function retakePhoto(photoType) {
    if (photoType === 'room_overview') {
        const photoArea = document.getElementById('room-photo-area');
        const previewArea = document.getElementById('room-photo-preview');
        const photoStatus = document.getElementById('room-photo-status');

        // æ’®å½±ã‚¨ãƒªã‚¢ã‚’å…ƒã«æˆ»ã™
        photoArea.classList.remove('completed');
        photoStatus.style.display = 'none';
        previewArea.style.display = 'none';

        // ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
        roomPhotoTaken = false;

        // æ–°ã—ã„å†™çœŸã‚’æ’®å½±
        capturePhoto(photoType);
    }
}

// ã‚¹ãƒ†ãƒƒãƒ—ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
function navigateToStep(stepId) {
    const currentUrl = window.location.href.split('?')[0];
    const urlParams = new URLSearchParams(window.location.search);
    const simpleParam = urlParams.get('simple') || urlParams.get('elderly') || urlParams.get('mobile');

    let newUrl = currentUrl + '?step=' + stepId;
    if (simpleParam) {
        newUrl += '&simple=' + simpleParam;
    }

    window.location.href = newUrl;
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
document.addEventListener('DOMContentLoaded', function() {
    // ã‚¹ãƒ†ãƒƒãƒ—é–‹å§‹APIå‘¼ã³å‡ºã—
    fetch(`/surveys/${surveyId}/step/${currentStepId}/start/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    });

    // éŸ³å£°ã‚¬ã‚¤ãƒ‰ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¯å‰Šé™¤æ¸ˆã¿
});
</script>
{% endblock %}