<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€²æ—æ›´æ–°ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆDBä¿å­˜ç‰ˆï¼‰</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>é€²æ—æ›´æ–°ãƒ¢ãƒ¼ãƒ€ãƒ« ãƒ†ã‚¹ãƒˆï¼ˆDBä¿å­˜ç‰ˆï¼‰</h1>
        <p>ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ DBä¿å­˜ã®è¿½åŠ é …ç›®æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚</p>

        <div class="row">
            <div class="col-md-6">
                <h3>ã‚¹ãƒ†ãƒƒãƒ—1: ç·¨é›†ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ</h3>
                <button type="button" class="btn btn-primary" onclick="createEditSession()">
                    <i class="fas fa-plus me-1"></i>ç·¨é›†ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
                </button>
                <div id="session-info" class="mt-3"></div>
            </div>
            <div class="col-md-6">
                <h3>ã‚¹ãƒ†ãƒƒãƒ—2: è¿½åŠ é …ç›®ã®ä¿å­˜</h3>
                <div class="mb-3">
                    <input type="text" id="test-key" class="form-control" placeholder="é …ç›®åï¼ˆä¾‹ï¼šä½¿ç”¨ææ–™ï¼‰">
                </div>
                <div class="mb-3">
                    <input type="text" id="test-value" class="form-control" placeholder="å†…å®¹">
                </div>
                <button type="button" class="btn btn-success" onclick="saveAdditionalItem()">
                    <i class="fas fa-save me-1"></i>é …ç›®ã‚’DBã«ä¿å­˜
                </button>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <h3>ã‚¹ãƒ†ãƒƒãƒ—3: é€²æ—æ›´æ–°ãƒ†ã‚¹ãƒˆ</h3>
                <button type="button" class="btn btn-warning" onclick="testProgressUpdate()">
                    <i class="fas fa-edit me-1"></i>é€²æ—æ›´æ–°ã‚’ãƒ†ã‚¹ãƒˆ
                </button>
            </div>
            <div class="col-md-6">
                <h3>ã‚¹ãƒ†ãƒƒãƒ—4: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª</h3>
                <button type="button" class="btn btn-info" onclick="loadEditSession()">
                    <i class="fas fa-search me-1"></i>ã‚»ãƒƒã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿
                </button>
            </div>
        </div>

        <div class="mt-4">
            <h3>ãƒ­ã‚°å‡ºåŠ›:</h3>
            <div id="log-output" class="border p-3" style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                <!-- ãƒ­ã‚°ãŒã“ã“ã«å‡ºåŠ›ã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
        const TEST_PROJECT_ID = 1;
        let currentSessionId = null;

        // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ï¼ˆæœ¬æ¥ã¯ãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ï¼‰
        function getCSRFToken() {
            return 'test-csrf-token'; // å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆã§ã¯ãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—
        }

        // ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
        function log(message) {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.innerHTML += `[${timestamp}] ${message}<br>`;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(message);
        }

        // ç·¨é›†ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
        function createEditSession() {
            log('ç·¨é›†ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™...');

            const formData = new FormData();
            formData.append('edit_mode', 'true');
            formData.append('action', 'update_mode');

            fetch(`http://localhost:8001/construction/projects/${TEST_PROJECT_ID}/edit-session/save/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentSessionId = data.session_id;
                    log(`âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæˆåŠŸ: ${currentSessionId}`);
                    document.getElementById('session-info').innerHTML =
                        `<div class="alert alert-success">ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${currentSessionId}</div>`;
                } else {
                    log(`âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå¤±æ•—: ${data.error}`);
                }
            })
            .catch(error => {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error}`);
            });
        }

        // è¿½åŠ é …ç›®ã‚’ä¿å­˜
        function saveAdditionalItem() {
            if (!currentSessionId) {
                log('âŒ å…ˆã«ç·¨é›†ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ãã ã•ã„');
                return;
            }

            const key = document.getElementById('test-key').value.trim();
            const value = document.getElementById('test-value').value.trim();

            if (!key || !value) {
                log('âŒ é …ç›®åã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            log(`è¿½åŠ é …ç›®ã‚’ä¿å­˜ã—ã¾ã™: ${key} = ${value}`);

            const formData = new FormData();
            formData.append('session_id', currentSessionId);
            formData.append('action', 'save_item');
            formData.append('key', key);
            formData.append('value', value);

            fetch(`http://localhost:8001/construction/projects/${TEST_PROJECT_ID}/edit-session/save/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    log(`âœ… è¿½åŠ é …ç›®ä¿å­˜æˆåŠŸ: ${key} = ${value}`);
                    log(`ğŸ“¦ ä¿å­˜ã•ã‚Œã¦ã„ã‚‹é …ç›®: ${JSON.stringify(data.additional_items)}`);

                    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                    document.getElementById('test-key').value = '';
                    document.getElementById('test-value').value = '';
                } else {
                    log(`âŒ è¿½åŠ é …ç›®ä¿å­˜å¤±æ•—: ${data.error}`);
                }
            })
            .catch(error => {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error}`);
            });
        }

        // é€²æ—æ›´æ–°ã‚’ãƒ†ã‚¹ãƒˆ
        function testProgressUpdate() {
            if (!currentSessionId) {
                log('âŒ å…ˆã«ç·¨é›†ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ãã ã•ã„');
                return;
            }

            log('é€²æ—æ›´æ–°ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™...');

            const formData = new FormData();
            formData.append('progress_rate', '75');
            formData.append('work_description', 'ãƒ†ã‚¹ãƒˆä½œæ¥­å†…å®¹');
            formData.append('issues', 'ãƒ†ã‚¹ãƒˆèª²é¡Œ');
            formData.append('craftsman', '1'); // æœ€åˆã®è·äººã‚’ä½¿ç”¨
            formData.append('session_id', currentSessionId);

            // è¿½åŠ ã®é …ç›®ã‚’ãƒ†ã‚¹ãƒˆ
            formData.append('additional_item_keys[]', 'ãƒ•ã‚©ãƒ¼ãƒ é …ç›®');
            formData.append('additional_item_values[]', 'ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰é€ä¿¡ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆå€¤');

            fetch(`http://localhost:8001/construction/projects/${TEST_PROJECT_ID}/quick-progress/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    log(`âœ… é€²æ—æ›´æ–°æˆåŠŸ: é€²æ—ID ${data.progress_id}, é€²æ—ç‡ ${data.progress_rate}%`);
                    log('ğŸ”„ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ');
                    currentSessionId = null;
                    document.getElementById('session-info').innerHTML =
                        '<div class="alert alert-info">ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ</div>';
                } else {
                    log(`âŒ é€²æ—æ›´æ–°å¤±æ•—: ${data.error || JSON.stringify(data.errors)}`);
                }
            })
            .catch(error => {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error}`);
            });
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿
        function loadEditSession() {
            log('ç·¨é›†ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã™...');

            let url = `http://localhost:8001/construction/projects/${TEST_PROJECT_ID}/edit-session/load/`;
            if (currentSessionId) {
                url += `?session_id=${currentSessionId}`;
            }

            fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    log(`âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿æˆåŠŸ`);
                    log(`ğŸ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: ${data.edit_mode}`);
                    log(`ğŸ“¦ è¿½åŠ é …ç›®: ${JSON.stringify(data.additional_items)}`);
                    if (data.session_id) {
                        currentSessionId = data.session_id;
                        document.getElementById('session-info').innerHTML =
                            `<div class="alert alert-success">ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${currentSessionId}</div>`;
                    }
                } else {
                    log(`âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿å¤±æ•—: ${data.error}`);
                }
            })
            .catch(error => {
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error}`);
            });
        }

        // åˆæœŸãƒ­ã‚°
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ“‹ DBä¿å­˜ç‰ˆè¿½åŠ é …ç›®ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
            log('ğŸ’¡ æ‰‹é †: 1) ç·¨é›†ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ â†’ 2) é …ç›®è¿½åŠ  â†’ 3) é€²æ—æ›´æ–°ãƒ†ã‚¹ãƒˆ');
        });
    </script>
</body>
</html>